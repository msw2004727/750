<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠ½èŠ½å·²å©šç¾¤å°ˆå±¬è©¦ç©<å¯©å•éŠæˆ²></å¯©å•éŠæˆ²></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            overscroll-behavior-y: contain;
        }
        .card {
            background-color: #2d3748;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dialogue-area {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #4a5568;
            padding: 10px;
            border-radius: 8px;
            background-color: #1f2937;
            min-height: 200px;
        }
        .dialogue-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            max-width: 85%;
            word-wrap: break-word;
            color: white; 
        }
        .player-bubble {
            background-color: #4299e1; 
            margin-left: auto;
            text-align: right;
        }
        .player-bubble-calm {
            background-color: #38a169; 
        }
        .player-bubble-angry {
            background-color: #e53e3e; 
        }
        .player-bubble-provocative {
            background-color: #d69e2e; 
        }
        .officer-bubble { /* Officer's statements */
            background-color: #38a169; /* Calm tone color */
            color: white;
            margin-left: auto; /* Align right like player */
            text-align: right;
        }
        .ai-bubble {
            background-color: #4a5568;
            color: #e2e8f0;
            margin-right: auto;
        }
        .keyword, .case-keyword { /* Added .case-keyword for dynamically generated keywords */
            text-decoration: underline;
            color: #63b3ed;
            cursor: pointer;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal-content {
            background-color: #2d3748;
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            max-width: 500px; 
            max-height: 90vh; 
            overflow-y: auto;
            text-align: left;
            color: #e2e8f0;
        }
        .modal-content.modal-lg {
            max-width: 600px;
        }
        .modal-content h3 {
            text-align: center;
            margin-bottom: 16px;
        }
        .story-summary-text {
            font-size: 0.8rem; 
        }
        .story-summary-divider {
            border-top: 1px solid #4a5568;
            margin: 12px 0;
        }
        .personality-block {
            background-color: #374151; 
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #4a5568;
        }
        #personality-modal {
            font-style: normal;
        }
        .tone-button {
            color: #e2e8f0;
            border: 1px solid #718096;
            flex-grow: 1;
            padding: 8px 0;
        }
        .tone-button-calm { background-color: #2c5282; } 
        .tone-button-calm.active { background-color: #3182ce; border-color: #3182ce; color:white;}

        .tone-button-angry { background-color: #9b2c2c; } 
        .tone-button-angry.active { background-color: #e53e3e; border-color: #e53e3e; color:white;}

        .tone-button-provocative { background-color: #975a16; } 
        .tone-button-provocative.active { background-color: #d69e2e; border-color: #d69e2e; color:white;}
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .game-main-area {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 20px); 
            padding: 8px;
        }
        #avatar {
            background-color: #4a5568; 
        }
        .interrogation-tip {
            font-size: 0.75rem; /* Smaller text */
            color: #a0aec0; /* Lighter gray */
            text-align: center;
            margin-top: 4px;
            padding: 4px;
            background-color: #2a303c; /* Slightly different background for the tip area */
            border-radius: 4px;
            min-height: 2.5em; /* Ensure space even if empty */
        }
    </style>
</head>
<body class="overscroll-y-contain">
    <div class="game-main-area container mx-auto">
        <header class="text-center mb-3">
            <h1 class="text-2xl sm:text-3xl font-bold text-blue-400">AI å¯©å•éŠæˆ²</h1>
            <div class="flex justify-around text-sm sm:text-base mt-1">
                <p>ğŸŸ¢ å›åˆæ•¸: <span id="round-count">0</span></p>
                <p>ğŸ—£ï¸ é ‘æŠ—åº¦: <span id="confession-meter-text">æ…‹åº¦å¼·ç¡¬</span></p>
            </div>
            <p class="text-xs mt-1" title="é€™æ˜¯ Firebase åŒ¿åèªè­‰ç‚ºæ‚¨çš„éŠæˆ²æœƒè©±ç”Ÿæˆçš„å”¯ä¸€æ¨™è­˜ï¼Œç”¨æ–¼ä¿å­˜éŠæˆ²é€²åº¦ã€‚">æ‚¨çš„ User ID: <span id="user-id-display">è¼‰å…¥ä¸­...</span></p>
        </header>

        <div class="flex gap-3 mb-3">
            <div id="avatar" class="w-20 h-20 sm:w-24 sm:h-24 rounded-md flex-shrink-0 flex items-center justify-center text-gray-400 text-xs sm:text-sm p-1 text-center">
                é ­åƒé ç•™
            </div>
            <div id="suspect-status-card" class="flex-grow flex flex-col gap-2 card p-2 text-xs sm:text-sm">
                 <h2 class="text-sm sm:text-base font-semibold mb-1 text-blue-300 text-center">å«ŒçŠ¯ç‹€æ…‹ (<span id="suspect-status-name"></span>)</h2>
                 <div id="suspect-status-details" class="grid grid-cols-2 gap-x-2 gap-y-1">
                    <p>ğŸ“ˆ<strong>å¿ƒç‡:</strong> <span id="heart-rate">75</span> bpm</p>
                    <p>ğŸ©¸<strong>è¡€å£“:</strong> <span id="blood-pressure">120/80</span></p>
                    <p>ğŸ˜ <strong>è¡¨æƒ…:</strong> <span id="facial-expression" class="italic">è®€å–ä¸­...</span></p>
                    <p>ğŸ§<strong>è‚¢é«”:</strong> <span id="body-language" class="italic">è®€å–ä¸­...</span></p>
                    <p>ğŸ¤<strong>å¾®å‹•ä½œ:</strong> <span id="micro-action" class="italic">è®€å–ä¸­...</span></p>
                    <p>ğŸ—£ï¸<strong>èªæ°£:</strong> <span id="voice-tone" class="italic">è®€å–ä¸­...</span></p>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-3">
            <button id="show-personal-details-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">ğŸ‘¤ å€‹äººè³‡æ–™</button>
            <button id="show-story-summary-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">ğŸ“œ æ¡ˆä»¶æ¦‚è¦</button>
        </div>

        <div id="dialogue-area" class="dialogue-area mb-3"></div>
        
        <div class="interrogation-tip" id="interrogation-tip-area">
            â€» åµè¨Šæç¤ºè¼‰å…¥ä¸­...
        </div>

        <div class="mt-auto pt-2"> <textarea id="player-input" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base" rows="2" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."></textarea>
            <div class="mt-2 flex gap-1 sm:gap-2">
                <button class="tone-button tone-button-calm active rounded-md text-xs sm:text-sm" data-tone="å¹³ç·©">ğŸ˜Œ å¹³ç·©</button>
                <button class="tone-button tone-button-angry rounded-md ml-1 text-xs sm:text-sm" data-tone="æ†¤æ€’">ğŸ˜¡ æ†¤æ€’</button>
                <button class="tone-button tone-button-provocative rounded-md ml-1 text-xs sm:text-sm" data-tone="æŒ‘é‡">ğŸ˜ æŒ‘é‡</button>
            </div>
             <button id="send-button" class="mt-2 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 text-sm sm:text-base">
                ç™¼é€
            </button>
        </div>
    </div>

    <div id="personal-details-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-300">ğŸ‘¤ å«ŒçŠ¯å€‹äººè³‡æ–™</h3>
            <div id="modal-personal-details-content">
                <p><strong>å§“å:</strong> <span id="suspect-name-modal">ææ˜</span></p>
                <p><strong>ç”Ÿæ—¥:</strong> <span id="dob-modal">è®€å–ä¸­...</span></p> <p><strong>æ˜Ÿåº§:</strong> <span id="zodiac-modal">è®€å–ä¸­...</span></p>
                <p><strong>è¡€å‹:</strong> <span id="blood-type-modal">è®€å–ä¸­...</span></p>
                <p><strong>å¹´ç´€:</strong> <span id="age-modal">è®€å–ä¸­...</span></p>
                <p><strong>æ€§åˆ¥:</strong> <span id="gender-modal">è®€å–ä¸­...</span></p>
                <div class="personality-block">
                    <p class="font-semibold mb-1">ğŸ­ å€‹æ€§æ¦‚è¿°:</p>
                    <p id="personality-modal" class="text-sm">è®€å–ä¸­...</p> 
                </div>
            </div>
            <button onclick="document.getElementById('personal-details-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="story-summary-modal" class="modal hidden">
        <div class="modal-content modal-lg"> 
            <h3 class="text-xl font-bold text-blue-300">ğŸ“œ æ¡ˆä»¶æ¦‚è¦</h3>
            <div id="modal-story-summary-content" class="story-summary-text">
                <div>
                    <p class="font-semibold">è¢«å®³äººé©—å±å ±å‘Š:</p>
                    <span id="autopsy-report-modal-content">è®€å–ä¸­...</span>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">å°å«ŒçŠ¯ä¸åˆ©çš„ç›®å‰è­‰æ“š:</p>
                    <ul id="evidence-list-modal-content" class="list-disc list-inside ml-4"><li>è®€å–ä¸­...</li></ul>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">å«ŒçŠ¯èª¿æŸ¥ç–‘é»:</p>
                    <ul id="doubts-list-modal-content" class="list-disc list-inside ml-4"><li>è®€å–ä¸­...</li></ul>
                </div>
            </div>
            <button onclick="document.getElementById('story-summary-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="keyword-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="keyword-modal-title" class="text-xl font-bold text-blue-300">ğŸ”‘ é—œéµå­—è£œå……</h3>
            <p id="keyword-modal-text">è£œå……å…§å®¹...</p>
            <div id="keyword-loading-spinner" class="loading-spinner my-4 hidden"></div>
            <button onclick="document.getElementById('keyword-modal').classList.add('hidden')" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">é—œé–‰</button>
        </div>
    </div>

    <div id="game-over-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h3 id="game-over-title" class="text-2xl font-bold mb-4">âš–ï¸ å¯©å•çµæŸ</h3>
            <p>ç¸½å…±è€—è²»å›åˆæ•¸: <span id="total-rounds">0</span></p>
            <div class="mt-4 text-left">
                 <p class="font-semibold mb-2">å¿ƒç†æ”»é˜²åˆ†æ:</p>
                 <p id="game-analysis-text" class="text-sm whitespace-pre-wrap">åˆ†æä¸­...</p>
            </div>
            <button id="restart-game-button" class="mt-6 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">ğŸ”„ é‡æ–°é–‹å§‹</button>
        </div>
    </div>
    
    <div id="ai-thinking-modal" class="modal hidden">
        <div class="modal-content text-center">
            <p class="text-lg">ğŸ¤– AI æ­£åœ¨æ€è€ƒå›æ‡‰...</p>
            <div class="loading-spinner my-4"></div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, serverTimestamp, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const roundCountEl = document.getElementById('round-count');
        const confessionMeterTextEl = document.getElementById('confession-meter-text');
        const heartRateEl = document.getElementById('heart-rate');
        const bloodPressureEl = document.getElementById('blood-pressure');
        const facialExpressionEl = document.getElementById('facial-expression');
        const bodyLanguageEl = document.getElementById('body-language');
        const microActionEl = document.getElementById('micro-action');
        const voiceToneEl = document.getElementById('voice-tone');
        const suspectStatusNameEl = document.getElementById('suspect-status-name'); 
        const suspectNameModalEl = document.getElementById('suspect-name-modal');
        const dobModalEl = document.getElementById('dob-modal');
        const zodiacModalEl = document.getElementById('zodiac-modal');
        const bloodTypeModalEl = document.getElementById('blood-type-modal');
        const ageModalEl = document.getElementById('age-modal');
        const genderModalEl = document.getElementById('gender-modal');
        const personalityModalEl = document.getElementById('personality-modal');
        const autopsyReportModalContentEl = document.getElementById('autopsy-report-modal-content');
        const evidenceListModalContentEl = document.getElementById('evidence-list-modal-content');
        const doubtsListModalContentEl = document.getElementById('doubts-list-modal-content');
        const showPersonalDetailsButton = document.getElementById('show-personal-details-button');
        const showStorySummaryButton = document.getElementById('show-story-summary-button');
        const personalDetailsModal = document.getElementById('personal-details-modal');
        const storySummaryModal = document.getElementById('story-summary-modal');
        const dialogueAreaEl = document.getElementById('dialogue-area');
        const playerInputEl = document.getElementById('player-input');
        const sendButton = document.getElementById('send-button');
        const toneButtons = document.querySelectorAll('.tone-button');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const keywordModal = document.getElementById('keyword-modal');
        const keywordModalTitle = document.getElementById('keyword-modal-title');
        const keywordModalText = document.getElementById('keyword-modal-text');
        const keywordLoadingSpinner = document.getElementById('keyword-loading-spinner');
        const gameOverModal = document.getElementById('game-over-modal');
        const gameOverTitle = document.getElementById('game-over-title');
        const totalRoundsEl = document.getElementById('total-rounds');
        const gameAnalysisTextEl = document.getElementById('game-analysis-text'); 
        const restartGameButton = document.getElementById('restart-game-button');
        const aiThinkingModal = document.getElementById('ai-thinking-modal');
        const avatarEl = document.getElementById('avatar'); 
        const suspectStatusCardEl = document.getElementById('suspect-status-card'); 
        const interrogationTipAreaEl = document.getElementById('interrogation-tip-area');

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('error'); 

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'interrogation-game-default';
        let userId = null;
        let gameId = `game_${Date.now()}`; 
        let gameStateUnsubscribe = null; 

        function getDefaultGameState() {
            return {
                round: 0,
                confessionMeter: 100, 
                suspect: {
                    name: "æœªçŸ¥å«ŒçŠ¯", 
                    dob: "", zodiac: "", bloodType: "", age: 0, gender: "",
                    personality: "è®€å–ä¸­...",
                    heartRate: 75, bloodPressure: "120/80", 
                    facialExpression: "è®€å–ä¸­...", bodyLanguage: "è®€å–ä¸­...", 
                    microAction: "è®€å–ä¸­...", voiceTone: "è®€å–ä¸­..."
                },
                caseDetails: { 
                    autopsyReport: "æ¡ˆä»¶ç”Ÿæˆä¸­...",
                    evidence: [], 
                    doubts: []    
                },
                dialogueHistory: [],
                selectedTone: "å¹³ç·©",
                gameOver: false,
                gameAnalysis: "" 
            };
        }
        let gameState = getDefaultGameState();
        
        function getConfessionMeterText(percentage) { /* Unchanged */
            if (percentage > 80) return "æ…‹åº¦å¼·ç¡¬";
            if (percentage > 60) return "æ•…ä½œé®å®š";
            if (percentage > 40) return "ç•¥é¡¯å‹•æ–";
            if (percentage > 20) return "å¿ƒè™›æ…Œäº‚";
            if (percentage > 0) return "ç€•è‡¨å´©æ½°";
            return "å·²ç„¶èªç½ª";
        }
        
        function adjustAvatarSize() { /* Unchanged */
            if (suspectStatusCardEl && avatarEl) {
                requestAnimationFrame(() => {
                    const height = suspectStatusCardEl.offsetHeight;
                    if (height > 0) {
                        avatarEl.style.height = `${height}px`;
                        avatarEl.style.width = `${height}px`; 
                    } else {
                        setTimeout(adjustAvatarSize, 100); 
                    }
                });
            }
        }

        async function initializeGame() { /* Unchanged */
             try {
                await setPersistence(auth, browserLocalPersistence);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication error:", error);
                if (error.code === 'auth/invalid-custom-token' || !auth.currentUser) {
                    try { await signInAnonymously(auth); } catch (anonError) {
                        console.error("Anonymous sign-in failed:", anonError);
                        userIdDisplayEl.textContent = "èªè­‰å¤±æ•—"; return;
                    }
                }
            }
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplayEl.textContent = userId.substring(0,8) + "..."; 
                } else {
                    userId = `anon_${crypto.randomUUID()}`;
                    userIdDisplayEl.textContent = "åŒ¿åè¨ªå®¢";
                }
                await loadOrCreateNewGame(); 
            });
        }
        
        async function getGameDocRef() { /* Unchanged */
            if (!userId) {
                const tempGameId = `local_game_${Date.now()}`;
                return doc(db, "localGames", tempGameId);
            }
            return doc(db, "artifacts", appId, "users", userId, "interrogationGames", gameId);
        }
        
        const DEEPSEEK_API_KEY = "sk-19179bb0c0c94acaa53ca82dc1d28bbf"; 
        const DEEPSEEK_API_URL = "https://api.deepseek.com/chat/completions";

        function cleanAIJsonResponse(rawResponse) {
            if (typeof rawResponse !== 'string') return null; // Return null or throw error if not a string

            let str = rawResponse.trim();
            
            // Attempt to remove markdown fences specifically for JSON
            const jsonMatch = str.match(/```json\s*([\s\S]*?)\s*```/);
            if (jsonMatch && jsonMatch[1]) {
                return jsonMatch[1].trim();
            }

            // Attempt to remove generic markdown fences if ```json...``` was not found
            const genericMatch = str.match(/```\s*([\s\S]*?)\s*```/);
            if (genericMatch && genericMatch[1]) {
                return genericMatch[1].trim();
            }
            
            // If no fences, assume it might be plain JSON (or already erroneous)
            return str;
        }


        async function callDeepSeekAPI(systemPrompt, userPrompt, forMultipleFields = false) { 
            aiThinkingModal.classList.remove('hidden');
            const payload = {
                model: "deepseek-chat", 
                messages: [ { role: "system", content: systemPrompt }, { role: "user", content: userPrompt } ],
                stream: false,
            };
            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${DEEPSEEK_API_KEY}`},
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`DS API Error ${response.status}: ${errorBody}`);
                }
                const result = await response.json();
                aiThinkingModal.classList.add('hidden');
                if (result.choices && result.choices.length > 0 && result.choices[0].message && result.choices[0].message.content) {
                    return result.choices[0].message.content;
                } else { throw new Error("Unexpected DS API response structure."); }
            } catch (error) {
                console.error("Error calling DeepSeek API:", error);
                aiThinkingModal.classList.add('hidden');
                return forMultipleFields ? { error: error.message } : `AI (DS) Error: ${error.message.substring(0,30)}`;
            }
        }

        async function generateRandomSuspectName() { /* Unchanged */
            const lastNames = ["æ", "ç‹", "å¼µ", "åŠ‰", "é™³", "æ¥Š", "é»ƒ", "è¶™", "å³", "å‘¨"];
            const firstNamesMale = ["å‰", "å¼·", "ç£Š", "è»", "å‹‡", "å‚‘", "æ¿¤", "æ˜", "è¶…", "éµ¬"];
            const firstNamesFemale = ["èŠ³", "å¨œ", "æ•", "éœ", "éº—", "è±”", "ä¸¹", "è", "å©·", "é›ª"];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            const gender = (Math.random() > 0.5) ? "ç”·æ€§" : "å¥³æ€§";
            const firstName = gender === "ç”·æ€§" ? firstNamesMale[Math.floor(Math.random() * firstNamesMale.length)] : firstNamesFemale[Math.floor(Math.random() * firstNamesFemale.length)];
            return { name: lastName + firstName, gender: gender };
        }
        
        async function generateInitialSuspectDetailsAndState() { /* Unchanged, uses cleanAIJsonResponse implicitly via generateSuspectObservableState */
            const { name, gender } = await generateRandomSuspectName();
            gameState.suspect.name = name;
            gameState.suspect.gender = gender;
            const dobTimestamp = Date.now() - Math.floor(Math.random() * 25 + 20) * 365 * 24 * 60 * 60 * 1000; 
            const birthDate = new Date(dobTimestamp);
            gameState.suspect.dob = `${birthDate.getFullYear()}å¹´${birthDate.getMonth() + 1}æœˆ${birthDate.getDate()}æ—¥`;
            gameState.suspect.age = new Date().getFullYear() - birthDate.getFullYear();
            gameState.suspect.zodiac = getZodiacSign(birthDate.getDate(), birthDate.getMonth() + 1);
            gameState.suspect.bloodType = ["A", "B", "AB", "O"][Math.floor(Math.random() * 4)] + "å‹";
            gameState.suspect.heartRate = 70 + Math.floor(Math.random() * 10) - 5;
            gameState.suspect.bloodPressure = `${115 + Math.floor(Math.random() * 10) - 5}/${75 + Math.floor(Math.random() * 10) - 5}`;

            const systemPersonalityPrompt = "ä½ æ˜¯ä¸€ä½éŠæˆ²NPCè¨­è¨ˆå¸«ã€‚è«‹åªæä¾›å€‹æ€§æè¿°æ–‡å­—ï¼Œé€™æ®µæè¿°å°‡ä½œç‚ºåµè¨ŠæŠ€å·§çš„é—œéµåƒè€ƒï¼Œæš—ç¤ºå«ŒçŠ¯å¯èƒ½çš„å¼±é»æˆ–æ‡‰å°æ–¹å¼ã€‚ä¸è¦åŒ…å«ä»»ä½•é¡å¤–çš„èªªæ˜æˆ–æ¨™ç±¤ã€‚";
            const userPersonalityPrompt = `ç‚ºä»¥ä¸‹èƒŒæ™¯çš„å¯©å•éŠæˆ²å«ŒçŠ¯ ${gameState.suspect.name} ç”Ÿæˆä¸€æ®µç°¡çŸ­çš„å€‹æ€§æ¦‚è¿°ï¼ˆç´„20-40å­—ï¼‰ï¼Œé€™æ®µæ¦‚è¿°æ‡‰æš—ç¤ºåµè¨Šæ™‚å¯åˆ©ç”¨çš„çªç ´å£æˆ–å…¶å¯èƒ½çš„è¡Œç‚ºæ¨¡å¼ï¼šæ€§åˆ¥ï¼š${gameState.suspect.gender}ï¼Œæ˜Ÿåº§ï¼š${gameState.suspect.zodiac}ï¼Œè¡€å‹ï¼š${gameState.suspect.bloodType}ï¼Œå¹´é½¡ï¼š${gameState.suspect.age}æ­²ã€‚ä¾‹å¦‚ï¼š"æ­¤äººå¤–è¡¨å¼·ç¡¬ï¼Œä½†æåŠå®¶äººæ™‚å¯èƒ½æƒ…ç·’æ³¢å‹•" æˆ– "æ¥µåº¦è‡ªè² ï¼Œå¯èƒ½è¢«å¥‰æ‰¿æˆ–è³ªç–‘å…¶èƒ½åŠ›æ‰€æ¿€æ€’"ã€‚`;
            const personalityResponse = await callDeepSeekAPI(systemPersonalityPrompt, userPersonalityPrompt);
            let cleanPersonality = personalityResponse;
             // Basic cleanup for personality, though less likely to have markdown
            if (typeof cleanPersonality === 'string') {
                cleanPersonality = cleanPersonality.replace(/```json|```/g, "").trim();
            }
            gameState.suspect.personality = (cleanPersonality && !cleanPersonality.startsWith("AI (DS) Error")) ? cleanPersonality : "æ€§æ ¼è¤‡é›œï¼Œéœ€è¬¹æ…æ‡‰å°ã€‚";

            const initialObservables = await generateSuspectObservableState("éŠæˆ²å‰›é–‹å§‹ï¼Œåµè¨Šå®¤æ°£æ°›åš´è‚…ã€‚");
            gameState.suspect.facialExpression = initialObservables.facialExpression || "é¢ç„¡è¡¨æƒ…";
            gameState.suspect.bodyLanguage = initialObservables.bodyLanguage || "é›™æ‰‹æ”¾åœ¨æ¡Œä¸Š";
            gameState.suspect.microAction = initialObservables.microAction || "å¶çˆ¾çœ¨çœ¼";
            gameState.suspect.voiceTone = initialObservables.voiceTone || "èªæ°£å¹³éœ";
        }

        async function generateNewCaseDetails() { /* Uses cleanAIJsonResponse */
            const systemPrompt = "ä½ æ˜¯æ‡¸ç–‘æ¡ˆä»¶åŠ‡æƒ…ç”¢ç”Ÿå™¨ã€‚è«‹ç‚ºä¸€å€‹å¯©å•éŠæˆ²ç”Ÿæˆä¸€å€‹å…¨æ–°çš„è¬€æ®ºæ¡ˆæ¦‚è¦ï¼ŒåŒ…å«é©—å±å ±å‘Šã€å°å«ŒçŠ¯ä¸åˆ©çš„è­‰æ“šã€ä»¥åŠå«ŒçŠ¯çš„èª¿æŸ¥ç–‘é»ã€‚å…§å®¹éœ€ç¬¦åˆé‚è¼¯ã€‚åœ¨è­‰æ“šå’Œç–‘é»ä¸­ï¼Œè‹¥æåŠå…·é«”çš„ç‰©å“ã€åœ°é»ã€æ™‚é–“æˆ–äº‹ä»¶ï¼Œè«‹ç”¨ ## å°‡å…¶åŒ…è£¹èµ·ä¾†ï¼Œä¾‹å¦‚ ##ç´…è‰²åœå·¾## æˆ– ##æ¡ˆç™¼ç•¶æ™š10é»##ã€‚ç¢ºä¿è¼¸å‡ºç‚ºJSONæ ¼å¼ï¼ŒåŒ…å«ä¸‰å€‹éµï¼š'autopsyReport' (å­—ä¸²), 'evidence' (å­—ä¸²é™£åˆ—), 'doubts' (å­—ä¸²é™£åˆ—)ã€‚ä¸è¦åŒ…å«ä»»ä½•markdownæ¨™è¨˜å¦‚```jsonæˆ–```ã€‚";
            const userPrompt = `ç”Ÿæˆä¸€å€‹æ–°çš„è¬€æ®ºæ¡ˆæƒ…ç¯€ã€‚å«ŒçŠ¯æ˜¯ ${gameState.suspect.name} (${gameState.suspect.gender}, ${gameState.suspect.age}æ­²)ã€‚è«‹ç¢ºä¿æ¡ˆä»¶æœ‰åŸºæœ¬é‚è¼¯æ€§ï¼Œè­‰æ“šå’Œç–‘é»è¦æœ‰é—œè¯æ€§ã€‚ä¾‹å¦‚ï¼Œé©—å±å ±å‘Šå¯åŒ…å«æ­»å› ã€æ­»äº¡æ™‚é–“ï¼›è­‰æ“šå¯ä»¥æ˜¯ç¾å ´ç™¼ç¾çš„ç‰©å“ã€ç›®æ“Šè€…è­‰è©ç­‰ï¼›ç–‘é»å¯ä»¥æ˜¯å«ŒçŠ¯çš„ä¸åœ¨å ´è­‰æ˜ç‘•ç–µã€èˆ‡è¢«å®³äººé—œä¿‚ç­‰ã€‚`;
            
            let caseData = null;
            const rawResponse = await callDeepSeekAPI(systemPrompt, userPrompt, true);
            const jsonString = cleanAIJsonResponse(rawResponse);

            try {
                if (jsonString && !jsonString.startsWith("AI (DS) Error") && typeof jsonString !== 'object') { // Ensure it's a string before parsing
                    caseData = JSON.parse(jsonString);
                } else if (jsonString && typeof jsonString === 'object' && jsonString.error) { // API call itself returned an error object
                     console.error("API error generating case:", jsonString.error);
                }
            } catch (e) {
                console.error("Failed to parse case details JSON:", e, "Cleaned string:", jsonString, "Raw response:", rawResponse);
            }

            if (caseData && caseData.autopsyReport && Array.isArray(caseData.evidence) && Array.isArray(caseData.doubts)) {
                gameState.caseDetails.autopsyReport = caseData.autopsyReport;
                gameState.caseDetails.evidence = caseData.evidence.map((item, index) => 
                    typeof item === 'string' ? { text: item, id: `ev_new_${index}` } : item
                );
                gameState.caseDetails.doubts = caseData.doubts.map((item, index) => 
                    typeof item === 'string' ? { text: item, id: `db_new_${index}` } : item
                );
            } else {
                gameState.caseDetails.autopsyReport = `è¢«å®³è€… ${["å¼µä¸‰","æå››","ç‹äº”"][Math.floor(Math.random()*3)]}ï¼Œæ­»æ–¼å®¶ä¸­ï¼Œåˆæ­¥åˆ¤æ–·ç‚ºä»–æ®ºï¼Œæ­»äº¡æ™‚é–“ç´„ç‚ºæ˜¨æ™šã€‚ç¾å ´ç™¼ç¾ ##ä¸€æŠŠæ°´æœåˆ€##ã€‚`;
                gameState.caseDetails.evidence = [ { text: `åœ¨è¢«å®³è€…é™„è¿‘æ‰¾åˆ°ä¸€æŠŠ ##æ²¾è¡€çš„åˆ€å­##ã€‚`, id: "ev_fb1"}, { text: `é„°å±…è¡¨ç¤ºåœ¨ ##æ˜¨æ™šä¹é»## å·¦å³è½åˆ°æ¿€çƒˆçˆ­åµè²ã€‚`, id: "ev_fb2"}];
                gameState.caseDetails.doubts = [ { text: `å«ŒçŠ¯ ${gameState.suspect.name} è²ç¨±ç•¶æ™‚ç¨è‡ªåœ¨å®¶ã€‚`, id: "db_fb1"}, { text: `å«ŒçŠ¯èˆ‡è¢«å®³è€…åœ¨ ##ä¸‰å¤©å‰## æ›¾å› é‡‘éŒ¢å•é¡Œç™¼ç”Ÿéçˆ­åŸ·ã€‚`, id: "db_fb2"}];
                console.warn("Using fallback case details due to generation/parsing error.");
            }
        }

        async function generateOpeningDialogue() { /* Unchanged */
            const officerOpeningSystemPrompt = "ä½ æ˜¯åµè¨ŠéŠæˆ²ä¸­çš„é–‹å ´è­¦å®˜ã€‚ä½ çš„ä»»å‹™æ˜¯ç°¡è¿°æ¡ˆæƒ…ä¸¦å‘ŠçŸ¥å«ŒçŠ¯æ¬Šåˆ©ã€‚";
            const officerOpeningUserPrompt = `å‘å«ŒçŠ¯ ${gameState.suspect.name} ç°¡è¿°åµæŸ¥æ¡ˆä»¶ï¼ˆåŸºæ–¼ä»¥ä¸‹æ¡ˆæƒ…æ¦‚è¦ï¼š${gameState.caseDetails.autopsyReport.substring(0,50)}...ï¼‰ä¸¦å‘ŠçŸ¥å…¶åœ¨å°ç£æ³•å¾‹ä¸‹çš„åŸºæœ¬æ¬Šåˆ©ï¼ˆä½ æœ‰æ¬Šä¿æŒç·˜é»˜ï¼›æœ‰æ¬Šé¸ä»»è¾¯è­·äººï¼›ä½ æ‰€èªªçš„ä¸€åˆ‡éƒ½å¯èƒ½ä½œç‚ºè­‰æ“šï¼‰ã€‚è«‹ç›´æ¥çµ¦å‡ºå®Œæ•´çš„é–‹å ´é™³è¿°ï¼Œèªæ°£åš´è‚…è€Œå°ˆæ¥­ã€‚`;
            const officerOpeningText = await callDeepSeekAPI(officerOpeningSystemPrompt, officerOpeningUserPrompt);
            if (officerOpeningText && !officerOpeningText.startsWith("AI (DS) Error")) {
                gameState.dialogueHistory.push({ speaker: "è­¦å®˜", text: officerOpeningText, tone: "å¹³ç·©" });
            } else {
                gameState.dialogueHistory.push({ speaker: "è­¦å®˜", text: `${gameState.suspect.name}ï¼Œæˆ‘å€‘å°±ä¸€å®—è¬€æ®ºæ¡ˆå‘ä½ é€²è¡Œè©¢å•ã€‚ä½ æœ‰æ¬Šä¿æŒç·˜é»˜ï¼Œæ‰€èªªçš„è©±å°‡å¯èƒ½æˆç‚ºè­‰æ“šã€‚ä½ ä¹Ÿæœ‰æ¬Šè˜è«‹å¾‹å¸«ã€‚`, tone: "å¹³ç·©" });
            }
            const suspectRebuttalSystemPrompt = `ä½ æ˜¯è¬€æ®ºæ¡ˆå«ŒçŠ¯ ${gameState.suspect.name} (å€‹æ€§: ${gameState.suspect.personality})ã€‚ä½ å‰›è½å®Œè­¦å®˜çš„é–‹å ´é™³è¿°åŠæ¬Šåˆ©å‘ŠçŸ¥ã€‚`;
            const suspectRebuttalUserPrompt = `é‡å°è­¦å®˜çš„é–‹å ´é™³è¿°ï¼Œç”Ÿæˆä¸€æ®µç°¡çŸ­çš„ç‹¡è¾¯å›æ‡‰ï¼Œä¸¦æåŠå°ç£æ³•å¾‹çš„ç„¡ç½ªæ¨å®šåŸå‰‡ã€‚`;
            const suspectRebuttalText = await callDeepSeekAPI(suspectRebuttalSystemPrompt, suspectRebuttalUserPrompt);
            if (suspectRebuttalText && !suspectRebuttalText.startsWith("AI (DS) Error")) {
                gameState.dialogueHistory.push({ speaker: "AI", text: suspectRebuttalText });
            } else {
                gameState.dialogueHistory.push({ speaker: "AI", text: "è­¦å®˜ï¼Œæˆ‘ä¸æ˜ç™½ã€‚æˆ‘æ˜¯æ¸…ç™½çš„ï¼Œæ³•å¾‹ä¸æ˜¯èªªç„¡ç½ªæ¨å®šå—ï¼Ÿ" });
            }
        }
        
        async function generateInterrogationTip() { /* Unchanged */
            const systemPrompt = "ä½ æ˜¯è³‡æ·±åµæ¢ï¼Œæä¾›åµè¨ŠæŠ€å·§æç¤ºã€‚";
            const userPrompt = `æ ¹æ“šç›®å‰å«ŒçŠ¯ ${gameState.suspect.name} çš„å€‹æ€§ï¼ˆ${gameState.suspect.personality}ï¼‰å’Œé ‘æŠ—åº¦ï¼ˆ${getConfessionMeterText(gameState.confessionMeter)}ï¼‰ï¼Œæä¾›ä¸€å¥ç°¡çŸ­çš„åµè¨ŠæŠ€å·§æç¤ºï¼ˆç´„15-25å­—ï¼‰ã€‚ä¾‹å¦‚ï¼š"â€»é¢å°å¼·ç¡¬çš„å«ŒçŠ¯ï¼Œé©æ™‚æ²‰é»˜å¯èƒ½æ¯”è¿½å•æ›´æœ‰æ•ˆã€‚" æˆ– "â€»ç•¶å«ŒçŠ¯æƒ…ç·’æ¿€å‹•æ™‚ï¼Œè¿½å•ç´°ç¯€å¯èƒ½ä½¿å…¶éœ²å‡ºç ´ç¶»ã€‚"ã€‚è«‹ä»¥ "â€» " é–‹é ­ã€‚`;
            const tip = await callDeepSeekAPI(systemPrompt, userPrompt);
            if (tip && !tip.startsWith("AI (DS) Error")) {
                interrogationTipAreaEl.textContent = tip;
            } else {
                interrogationTipAreaEl.textContent = "â€» ä¿æŒå†·éœï¼Œè§€å¯Ÿå«ŒçŠ¯çš„æ¯ä¸€å€‹åæ‡‰ã€‚"; 
            }
        }

        async function generateGameAnalysis() { /* Unchanged */
            const systemPrompt = "ä½ æ˜¯æ¡ˆä»¶åˆ†æå“¡ï¼Œè² è²¬åœ¨å¯©å•éŠæˆ²çµæŸå¾Œæä¾›å¿ƒç†æ”»é˜²åˆ†æã€‚";
            const dialogueSummary = gameState.dialogueHistory.slice(-10).map(msg => `${msg.speaker === "Player" ? "åµè¨Šå“¡" : gameState.suspect.name}(${msg.speaker === "è­¦å®˜" ? "è­¦å®˜" : msg.speaker}): ${msg.text}`).join("\n");
            const userPrompt = `å¯©å•éŠæˆ²å·²çµæŸã€‚å«ŒçŠ¯ ${gameState.suspect.name} ${gameState.confessionMeter <= 0 ? "å·²èªç½ª" : "æœªèªç½ª"}ã€‚ç¸½å…±è€—è²» ${gameState.round} å›åˆã€‚é ‘æŠ—åº¦æœ€çµ‚ç‚º ${getConfessionMeterText(gameState.confessionMeter)} (${gameState.confessionMeter}%)ã€‚\nå«ŒçŠ¯å€‹æ€§ç‚ºï¼š${gameState.suspect.personality}ã€‚\néƒ¨åˆ†å°è©±è¨˜éŒ„æ‘˜è¦ï¼š\n${dialogueSummary}\nè«‹æ ¹æ“šä»¥ä¸Šè³‡è¨Šï¼Œæä¾›ä¸€æ®µç´„50-100å­—çš„å¿ƒç†æ”»é˜²åˆ†æï¼Œè©•åƒ¹é›™æ–¹çš„è¡¨ç¾ï¼Œä¸¦æŒ‡å‡ºå¯èƒ½çš„è½‰æŠ˜é»æˆ–ç­–ç•¥ã€‚`;
            const analysis = await callDeepSeekAPI(systemPrompt, userPrompt);
            if (analysis && !analysis.startsWith("AI (DS) Error")) {
                gameState.gameAnalysis = analysis;
            } else {
                gameState.gameAnalysis = "æœ¬æ¬¡å¯©å•éç¨‹è¤‡é›œï¼Œæœªèƒ½æˆåŠŸç²å–AIç”Ÿæˆçš„è©³ç´°åˆ†æã€‚è«‹æª¢æŸ¥APIé€£ç·šæˆ–æç¤ºè©ã€‚";
            }
        }

        async function loadOrCreateNewGame() { /* Unchanged */
            gameId = `game_${Date.now()}`; 
            gameState = getDefaultGameState(); 
            if (!userId) { 
                await generateInitialSuspectDetailsAndState(); 
                await generateNewCaseDetails();
                await generateOpeningDialogue();
                await generateInterrogationTip(); 
                updateUI(gameState); 
                adjustAvatarSize();
                return;
            }
            const gameDocRef = await getGameDocRef();
            if (gameStateUnsubscribe) gameStateUnsubscribe(); 
            console.log("Starting new game for user:", userId, "Game ID:", gameId);
            await generateInitialSuspectDetailsAndState(); 
            await generateNewCaseDetails(); 
            await generateOpeningDialogue(); 
            await generateInterrogationTip(); 
            try {
                await setDoc(gameDocRef, { ...gameState, createdAt: serverTimestamp(), lastUpdatedAt: serverTimestamp() });
                console.log("New game state saved to Firestore.");
            } catch (error) {
                console.error("Error saving new game state to Firestore:", error);
            }
            updateUI(gameState);
            adjustAvatarSize();
            gameStateUnsubscribe = onSnapshot(gameDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    console.log("Game state updated from Firestore:", docSnapshot.data());
                    const remoteGameState = docSnapshot.data();
                    gameState = { ...gameState, ...remoteGameState }; 
                     if (!gameState.suspect || !gameState.suspect.dob || !gameState.suspect.facialExpression) {
                        generateInitialSuspectDetailsAndState().then(() => updateUI(gameState));
                    } else {
                        updateUI(gameState);
                    }
                     adjustAvatarSize(); 
                }
            }, (error) => console.error("Error in onSnapshot listener:", error));
        }

        async function saveGameState() { /* Unchanged */
            if (!userId) return; 
            const gameDocRef = await getGameDocRef();
            if (!gameDocRef) return;
            try {
                await setDoc(gameDocRef, { ...gameState, lastUpdatedAt: serverTimestamp() }, { merge: true });
            } catch (error) { console.error("Error saving game state:", error); }
        }
        
        function getZodiacSign(day, month) { /* Unchanged */
            const zodiacSigns = [
                { sign: "æ‘©ç¾¯åº§", start: [12, 22], end: [1, 19] }, { sign: "æ°´ç“¶åº§", start: [1, 20], end: [2, 18] },
                { sign: "é›™é­šåº§", start: [2, 19], end: [3, 20] }, { sign: "ç™½ç¾Šåº§", start: [3, 21], end: [4, 19] },
                { sign: "é‡‘ç‰›åº§", start: [4, 20], end: [5, 20] }, { sign: "é›™å­åº§", start: [5, 21], end: [6, 21] },
                { sign: "å·¨èŸ¹åº§", start: [6, 22], end: [7, 22] }, { sign: "ç…å­åº§", start: [7, 23], end: [8, 22] },
                { sign: "è™•å¥³åº§", start: [8, 23], end: [9, 22] }, { sign: "å¤©ç§¤åº§", start: [9, 23], end: [10, 23] },
                { sign: "å¤©è åº§", start: [10, 24], end: [11, 22] }, { sign: "å°„æ‰‹åº§", start: [11, 23], end: [12, 21] }
            ];
            for (const z of zodiacSigns) {
                if ((month === z.start[0] && day >= z.start[1]) || (month === z.end[0] && day <= z.end[1])) { return z.sign; }
            }
            return "æœªçŸ¥";
        }

        async function getAIResponse(playerMessage) { /* Unchanged */
            const evidenceText = gameState.caseDetails.evidence.map(e => e.text.replace(/<[^>]*>/g, "")).join("ï¼›");
            const doubtsText = gameState.caseDetails.doubts.map(d => d.text.replace(/<[^>]*>/g, "")).join("ï¼›");
            const systemPrompt = `ä½ æ˜¯è¬€æ®ºæ¡ˆå«ŒçŠ¯ ${gameState.suspect.name} (å€‹æ€§: ${gameState.suspect.personality})ã€‚\nä½ ç›®å‰çš„é ‘æŠ—åº¦è¢«æè¿°ç‚ºã€Œ${getConfessionMeterText(gameState.confessionMeter)}ã€ã€‚\nç”Ÿç†ç‹€æ…‹ï¼šå¿ƒç‡ ${gameState.suspect.heartRate} bpmï¼Œè¡€å£“ ${gameState.suspect.bloodPressure}ã€‚\nå¤–åœ¨è¡¨ç¾ï¼šè¡¨æƒ… ${gameState.suspect.facialExpression}ï¼Œè‚¢é«” ${gameState.suspect.bodyLanguage}ï¼Œå¾®å‹•ä½œ ${gameState.suspect.microAction}ï¼Œèªæ°£ ${gameState.suspect.voiceTone}ã€‚\nä½ çš„ç›®æ¨™æ˜¯ç›¡å¯èƒ½ä¸èªç½ªï¼Œä½†å›ç­”è¦ç¬¦åˆä½ çš„å€‹æ€§å’Œç•¶å‰æƒ…å¢ƒã€‚\nå¦‚æœä½ çš„æƒ…ç·’è®Šå¾—æ¿€å‹•ã€æ…Œäº‚æˆ–è©¦åœ–èƒ¡è¨€äº‚èªï¼Œä½ å¯ä»¥ç”¨å¤šå€‹ç°¡çŸ­çš„å°è©±æ¡†ä¾†å›æ‡‰ï¼ˆç”¨ "||" åˆ†éš”æ¯å€‹å°è©±æ¡†çš„å…§å®¹ï¼‰ã€‚\nå›ç­”æ™‚ï¼Œå¦‚æœæåˆ°æ¡ˆä»¶ç›¸é—œçš„é—œéµç‰©å“æˆ–åœ°é»ï¼ˆä¾‹å¦‚ï¼šæ§Œå­ã€å…¬å¯“ã€å…¬åœ’ã€åˆ€æ¢°ã€è¢«å®³è€…å§“åã€ç‰¹å®šæ™‚é–“é»ï¼‰ï¼Œè«‹åœ¨è©²è©å½™å‰å¾ŒåŠ ä¸Š @@ï¼Œä¾‹å¦‚ @@æ§Œå­@@ã€‚\nä½ çš„å›ç­”æ‡‰è©²ç°¡æ½”æœ‰åŠ›ã€‚`;
            const userPrompt = `ç›®å‰å°ä½ ä¸åˆ©çš„è­‰æ“šæœ‰ï¼š${evidenceText}ã€‚èª¿æŸ¥äººå“¡å°ä½ çš„ç–‘é»æ˜¯ï¼š${doubtsText}ã€‚å¯©å•è€…ï¼ˆç©å®¶ï¼‰ç”¨ã€Œ${gameState.selectedTone}ã€çš„èªæ°£å•ä½ ï¼šã€Œ${playerMessage}ã€`;
            const response = await callDeepSeekAPI(systemPrompt, userPrompt);
            if (response && !response.startsWith("AI (DS) Error")) { return response.split("||").map(r => r.trim()); }
            return ["æˆ‘ä¸çŸ¥é“ä½ åœ¨èªªä»€éº¼ã€‚"]; 
        }

        async function getKeywordInfo(keyword) { /* Unchanged */
            keywordLoadingSpinner.classList.remove('hidden');
            keywordModalText.textContent = ""; 
            const systemPrompt = "ä½ æ˜¯ä¸€ä½åµæ¢åŠ©æ‰‹ï¼Œæä¾›æ¡ˆä»¶ç·šç´¢ã€‚";
            const userPrompt = `åœ¨ä¸€å€‹è¬€æ®ºæ¡ˆçš„å¯©å•æƒ…å¢ƒä¸­ï¼Œæåˆ°äº†é—œéµå­—ã€Œ${keyword}ã€ã€‚è«‹é‡å°é€™å€‹é—œéµå­—ï¼Œæä¾›ä¸€æ®µç°¡çŸ­ï¼ˆç´„30-50å­—ï¼‰çš„è£œå……è³‡è¨Šæˆ–ç·šç´¢ï¼Œé€™æ®µè³‡è¨Šæ‡‰è©²å°ç©å®¶ï¼ˆå¯©å•è€…ï¼‰æœ‰æ‰€å¹«åŠ©ã€‚ä¾‹å¦‚ï¼Œå¦‚æœé—œéµå­—æ˜¯ã€Œæ§Œå­ã€ï¼Œä½ å¯ä»¥èªªï¼šã€Œè­¦æ–¹åœ¨æ¡ˆç™¼ç¾å ´æ‰¾åˆ°ä¸€æŠŠå¸¶æœ‰è¡€è·¡çš„æ§Œå­ï¼Œä¸Šé¢åŒæ™‚æœ‰è¢«å®³è€…çš„DNAå’Œä¸€æšæ¨¡ç³Šçš„æŒ‡ç´‹ï¼Œæ­£åœ¨é€²è¡Œæ¯”å°ã€‚ã€å¦‚æœé—œéµå­—æ˜¯ã€Œå…¬åœ’ã€ï¼Œä½ å¯ä»¥èªªï¼šã€Œæ ¹æ“šé€šè¨Šè¨˜éŒ„ï¼Œè¢«å®³è€…æ‰‹æ©Ÿæœ€å¾Œçš„è¨Šè™Ÿä½ç½®æ˜¯åœ¨åŸå¸‚ä¸­å¤®å…¬åœ’é™„è¿‘ã€‚ã€è«‹ç›´æ¥çµ¦å‡ºè£œå……è³‡è¨Šï¼Œä¸è¦æœ‰é¡å¤–çš„é–‹é ­æˆ–çµå°¾ã€‚`;
            const info = await callDeepSeekAPI(systemPrompt, userPrompt);
            keywordLoadingSpinner.classList.add('hidden');
            if (info && !info.startsWith("AI (DS) Error")) { keywordModalText.textContent = info; } 
            else { keywordModalText.textContent = `é—œæ–¼ã€Œ${keyword}ã€çš„æ›´å¤šè³‡è¨Šç›®å‰ç„¡æ³•å–å¾—ã€‚`; }
        }
        
        async function generateSuspectObservableState(lastAIMessage = "") { /* Uses cleanAIJsonResponse */
            const systemPrompt = "ä½ æ˜¯çŠ¯ç½ªå¿ƒç†å´å¯«å¸«ã€‚æ ¹æ“šæä¾›çš„å«ŒçŠ¯è³‡æ–™å’Œæœ€è¿‘çš„å°è©±ï¼Œç”Ÿæˆä¸€å€‹JSONæ ¼å¼çš„å°è±¡ï¼Œæè¿°å«ŒçŠ¯ç•¶å‰çš„å¤–åœ¨è¡¨ç¾ã€‚è«‹ç¢ºä¿åªè¿”å›åˆæ³•çš„JSONå°è±¡ï¼Œä¸è¦åŒ…å«ä»»ä½•markdownæ¨™è¨˜å¦‚```jsonæˆ–```ã€‚";
            const userPrompt = `å«ŒçŠ¯ ${gameState.suspect.name} (å€‹æ€§: ${gameState.suspect.personality})ã€‚\nç›®å‰å¿ƒç‡: ${gameState.suspect.heartRate} bpmï¼Œè¡€å£“: ${gameState.suspect.bloodPressure} mmHgã€‚\né ‘æŠ—åº¦æè¿°ç‚ºã€Œ${getConfessionMeterText(gameState.confessionMeter)}ã€(å…§éƒ¨æ•¸å€¼: ${gameState.confessionMeter}%)ã€‚\nä»–å‰›å‰›èªªäº† (æˆ–è¢«å•äº†): "${lastAIMessage || 'åµè¨Šå‰›é–‹å§‹'}"ã€‚\nè«‹ç”Ÿæˆä¸€å€‹åˆæ³•çš„JSONå°è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å››å€‹éµå€¼å°ï¼Œæ¯å€‹å€¼éƒ½æ˜¯ä¸€æ®µç°¡çŸ­çš„æè¿° (æ¯é …ç´„5-10å­—):\n"facialExpression": (ä¾‹å¦‚ï¼š"å˜´è§’å¾®å¾®æŠ½å‹•", "çœ¼ç¥æœ‰äº›é£„å¿½ä¸å®š", "é¢ç„¡è¡¨æƒ…ä½†çœ‰é ­å¾®è¹™")\n"bodyLanguage": (ä¾‹å¦‚ï¼š"é›™æ‰‹ç·Šæ¡æ”¾åœ¨æ¡Œä¸Š", "åç«‹ä¸å®‰ï¼Œèº«é«”ç¨å¾®å¾Œä»°", "èº«é«”å¾®å¾®å‰å‚¾ï¼Œä¼¼ä¹æƒ³è§£é‡‹")\n"microAction": (ä¾‹å¦‚ï¼š"æ‰‹æŒ‡ä¸è‡ªè¦ºåœ°è¼•æ•²æ¡Œé¢", "ä¸‹æ„è­˜æ’¥å¼„è¡£è§’", "çŸ­æš«åœ°èˆ”äº†èˆ”å˜´å”‡")\n"voiceTone": (ä¾‹å¦‚ï¼š"èªæ°£å¹³æ·¡ï¼Œè½ä¸å‡ºæƒ…ç·’", "è²éŸ³ç•¥é¡¯æ²™å•", "è©¦åœ–ä¿æŒå¼·ç¡¬ä½†ç•¥å¸¶é¡«æŠ–")\nç¢ºä¿è¼¸å‡ºç‚ºä¸€å€‹å–®ä¸€çš„ã€åˆæ³•çš„JSONå°è±¡ï¼Œä¸è¦æœ‰ä»»ä½•é¡å¤–çš„æ–‡å­—æˆ–æ¨™è¨˜ã€‚`;
            
            const rawResponse = await callDeepSeekAPI(systemPrompt, userPrompt, true); 
            const jsonString = cleanAIJsonResponse(rawResponse);
            
            try {
                if (jsonString && !jsonString.startsWith("AI (DS) Error") && typeof jsonString !== 'object') {
                    const parsed = JSON.parse(jsonString);
                    if (typeof parsed === 'object' && parsed !== null && 
                        'facialExpression' in parsed && 'bodyLanguage' in parsed &&
                        'microAction' in parsed && 'voiceTone' in parsed) {
                        return parsed;
                    } else {
                         console.warn("Parsed JSON for observable state is not in expected format:", parsed);
                    }
                } else if (jsonString && typeof jsonString === 'object' && jsonString.error) {
                    console.error("DS API returned an error for observable state:", jsonString.error);
                }
            } catch (e) { 
                console.error("Failed to parse observable state JSON:", e, "Cleaned string:", jsonString, "Raw response:", rawResponse); 
            }
            console.warn("Using fallback observable state.");
            return { facialExpression: "é®å®šè‡ªè‹¥", bodyLanguage: "å§¿æ…‹æ”¾é¬†", microAction: "ç„¡æ˜é¡¯", voiceTone: "èªæ°£å¹³ç©©"};
        }

        async function updateSuspectStatus(lastAIMessage = "") { /* Unchanged */
            let hrChange = Math.floor(Math.random() * 10) - 5; 
            let bpSysChange = Math.floor(Math.random() * 10) - 5;
            let bpDiaChange = Math.floor(Math.random() * 6) - 3;
            if (gameState.confessionMeter < 50) { 
                hrChange += Math.floor(Math.random() * (gameState.confessionMeter < 25 ? 10 : 5)) + (gameState.confessionMeter < 25 ? 3 : 2); 
                bpSysChange += Math.floor(Math.random() * (gameState.confessionMeter < 25 ? 10 : 5)) + (gameState.confessionMeter < 25 ? 3 : 2);
            } else { 
                 hrChange -= Math.floor(Math.random() * 3); 
                 bpSysChange -= Math.floor(Math.random() * 3);
            }
            gameState.suspect.heartRate = Math.max(60, Math.min(140, gameState.suspect.heartRate + hrChange)); 
            let [sys, dia] = gameState.suspect.bloodPressure.split('/').map(Number);
            sys = Math.max(90, Math.min(190, sys + bpSysChange));
            dia = Math.max(60, Math.min(120, dia + bpDiaChange));
            gameState.suspect.bloodPressure = `${sys}/${dia}`;
            const newObservables = await generateSuspectObservableState(lastAIMessage);
            gameState.suspect.facialExpression = newObservables.facialExpression || gameState.suspect.facialExpression; 
            gameState.suspect.bodyLanguage = newObservables.bodyLanguage || gameState.suspect.bodyLanguage;
            gameState.suspect.microAction = newObservables.microAction || gameState.suspect.microAction;
            gameState.suspect.voiceTone = newObservables.voiceTone || gameState.suspect.voiceTone;
        }

        function updateUI(state) { /* Unchanged */
            if (!state) return;
            roundCountEl.textContent = state.round;
            confessionMeterTextEl.textContent = getConfessionMeterText(state.confessionMeter); 
            if (state.suspect) {
                suspectStatusNameEl.textContent = state.suspect.name; 
                heartRateEl.textContent = state.suspect.heartRate;
                bloodPressureEl.textContent = state.suspect.bloodPressure;
                facialExpressionEl.textContent = state.suspect.facialExpression;
                bodyLanguageEl.textContent = state.suspect.bodyLanguage;
                microActionEl.textContent = state.suspect.microAction;
                voiceToneEl.textContent = state.suspect.voiceTone;
                suspectNameModalEl.textContent = state.suspect.name;
                dobModalEl.textContent = state.suspect.dob || "N/A";
                zodiacModalEl.textContent = state.suspect.zodiac || "N/A";
                bloodTypeModalEl.textContent = state.suspect.bloodType || "N/A";
                ageModalEl.textContent = state.suspect.age || "N/A";
                genderModalEl.textContent = state.suspect.gender || "N/A";
                personalityModalEl.textContent = state.suspect.personality || "è®€å–ä¸­...";
            }
            if (state.caseDetails) { 
                autopsyReportModalContentEl.innerHTML = state.caseDetails.autopsyReport.replace(/##(.*?)##/g, '<span class="case-keyword" data-keyword="$1">$1</span>').replace(/\n/g, "<br>");
                evidenceListModalContentEl.innerHTML = state.caseDetails.evidence.map(e => `<li data-id="${e.id}">${e.text.replace(/##(.*?)##/g, '<span class="case-keyword" data-keyword="$1">$1</span>')}</li>`).join('');
                doubtsListModalContentEl.innerHTML = state.caseDetails.doubts.map(d => `<li data-id="${d.id}">${d.text.replace(/##(.*?)##/g, '<span class="case-keyword" data-keyword="$1">$1</span>')}</li>`).join('');
            }
            dialogueAreaEl.innerHTML = ''; 
            if (state.dialogueHistory) {
                state.dialogueHistory.forEach(msg => addMessageToDialogue(msg.speaker, msg.text, msg.tone)); 
            }
            document.querySelectorAll('.case-keyword').forEach(el => {
                el.onclick = () => {
                    const keyword = el.dataset.keyword;
                    keywordModalTitle.textContent = `ğŸ”‘ é—œæ–¼ã€Œ${keyword}ã€`;
                    getKeywordInfo(keyword); 
                    keywordModal.classList.remove('hidden');
                };
            });
            if (state.gameOver) {
                gameOverTitle.textContent = state.confessionMeter <= 0 ? "âš–ï¸ å¯©å•æˆåŠŸï¼" : "âš–ï¸ å¯©å•å¤±æ•—ï¼";
                totalRoundsEl.textContent = state.round;
                gameAnalysisTextEl.textContent = state.gameAnalysis || "åˆ†æç”Ÿæˆå¤±æ•—ã€‚";
                gameOverModal.classList.remove('hidden');
            } else {
                gameOverModal.classList.add('hidden');
            }
            adjustAvatarSize();
        }

        function addMessageToDialogue(speaker, text, tone = null) { /* Unchanged */
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('dialogue-bubble');
            let messageContent = text;
            if (speaker === 'Player') {
                messageDiv.classList.add('player-bubble');
                messageContent = `(èªæ°£ï¼š${tone || 'æœªçŸ¥'}) ${text}`; 
                switch (tone) {
                    case 'å¹³ç·©': messageDiv.classList.add('player-bubble-calm'); break;
                    case 'æ†¤æ€’': messageDiv.classList.add('player-bubble-angry'); break;
                    case 'æŒ‘é‡': messageDiv.classList.add('player-bubble-provocative'); break;
                }
            } else if (speaker === 'è­¦å®˜') { 
                messageDiv.classList.add('officer-bubble'); 
                messageContent = `<strong>è­¦å®˜ï¼š</strong> ${text}`;
            } else { 
                messageDiv.classList.add('ai-bubble');
            }
            const processedText = messageContent.replace(/@@(.*?)@@/g, '<span class="keyword" data-keyword="$1">$1</span>');
            messageDiv.innerHTML = processedText;
            dialogueAreaEl.appendChild(messageDiv);
            dialogueAreaEl.scrollTop = dialogueAreaEl.scrollHeight; 
            messageDiv.querySelectorAll('.keyword').forEach(el => {
                el.onclick = () => {
                    const keyword = el.dataset.keyword;
                    keywordModalTitle.textContent = `ğŸ”‘ é—œæ–¼ã€Œ${keyword}ã€`;
                    getKeywordInfo(keyword); 
                    keywordModal.classList.remove('hidden');
                };
            });
        }

        async function handlePlayerTurn() { /* Unchanged */
            const playerMessage = playerInputEl.value.trim();
            if (!playerMessage) return;
            if (playerMessage === "88888888") {
                gameState.confessionMeter = 0; gameState.gameOver = true;
                await generateGameAnalysis(); 
                updateUI(gameState); await saveGameState(); playerInputEl.value = ''; return;
            }
            sendButton.disabled = true;
            sendButton.innerHTML = '<div class="loading-spinner !w-5 !h-5 border-t-white"></div>';
            const currentTone = gameState.selectedTone; 
            gameState.round++;
            addMessageToDialogue('Player', playerMessage, currentTone);
            gameState.dialogueHistory.push({ speaker: 'Player', text: playerMessage, tone: currentTone });
            playerInputEl.value = '';
            const aiResponses = await getAIResponse(playerMessage);
            aiResponses.forEach(response => {
                addMessageToDialogue('AI', response);
                gameState.dialogueHistory.push({ speaker: 'AI', text: response });
            });
            let decrease = 5 + Math.floor(Math.random() * 10); 
            if (currentTone === "æŒ‘é‡" && Math.random() < 0.4) decrease += 5; 
            if (currentTone === "æ†¤æ€’" && Math.random() < 0.2) decrease -= 3; 
            if (playerMessage.length > 30 && Math.random() < 0.3) decrease +=3; 
            gameState.confessionMeter = Math.max(0, gameState.confessionMeter - decrease);
            await updateSuspectStatus(aiResponses.join(" ")); 
            await generateInterrogationTip(); 
            if (gameState.confessionMeter <= 0 && !gameState.gameOver) { 
                gameState.gameOver = true;
                const confessionMsg = `${gameState.suspect.name}: ...å¥½å§ï¼Œæˆ‘æ‰¿èª...æ˜¯æˆ‘åšçš„ã€‚`;
                addMessageToDialogue('AI', confessionMsg);
                gameState.dialogueHistory.push({ speaker: 'AI', text: confessionMsg });
                await generateGameAnalysis(); 
            }
            updateUI(gameState); 
            await saveGameState();
            sendButton.disabled = false;
            sendButton.innerHTML = 'ç™¼é€';
        }

        function restartGame() { /* Unchanged */
            loadOrCreateNewGame(); 
            gameOverModal.classList.add('hidden'); 
        }

        // Event Listeners
        sendButton.addEventListener('click', handlePlayerTurn);
        playerInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handlePlayerTurn(); }
        });
        toneButtons.forEach(button => {
            button.addEventListener('click', () => {
                toneButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                gameState.selectedTone = button.dataset.tone;
            });
        });
        showPersonalDetailsButton.addEventListener('click', () => personalDetailsModal.classList.remove('hidden'));
        showStorySummaryButton.addEventListener('click', () => storySummaryModal.classList.remove('hidden'));
        restartGameButton.addEventListener('click', restartGame);

        window.addEventListener('load', () => { initializeGame(); });
        window.addEventListener('resize', adjustAvatarSize); 

    </script>
</body>
</html>
