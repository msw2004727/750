# app.py
import os
import json
import requests
import firebase_admin
from firebase_admin import credentials, firestore
from flask import Flask, request, jsonify
from flask_cors import CORS

# --- åˆå§‹åŒ– Flask æ‡‰ç”¨ ---
app = Flask(__name__)
# å…è¨±ä¾†è‡ªä»»ä½•ä¾†æºçš„è·¨åŸŸè«‹æ±‚ï¼Œé€™å°æ–¼å‰å¾Œç«¯åˆ†é›¢çš„é–‹ç™¼è‡³é—œé‡è¦
CORS(app)

# --- åˆå§‹åŒ– Firebase Admin SDK ---
try:
    # Render æœƒå°‡ JSON å…§å®¹ä½œç‚ºä¸€å€‹å­—ä¸²è®€å…¥ç’°å¢ƒè®Šæ•¸
    firebase_creds_str = os.environ.get('FIREBASE_SERVICE_ACCOUNT_KEY')
    if not firebase_creds_str:
        raise ValueError("Firebase æœå‹™å¸³è™Ÿé‡‘é‘°æœªåœ¨ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®šï¼")

    # å°‡ JSON å­—ä¸²è§£æç‚º Python å­—å…¸
    service_account_info = json.loads(firebase_creds_str)

    # ä½¿ç”¨è§£æå¾Œçš„å­—å…¸åˆå§‹åŒ–æ†‘è­‰
    cred = credentials.Certificate(service_account_info)
    firebase_admin.initialize_app(cred, {
        'projectId': service_account_info.get('project_id'),
    })
    db = firestore.client()
    print("Firebase åˆå§‹åŒ–æˆåŠŸï¼")
except Exception as e:
    print(f"Firebase åˆå§‹åŒ–å¤±æ•—: {e}")
    db = None

# --- AI API è¨­å®š ---
DEEPSEEK_API_URL = "https://api.deepseek.com/chat/completions"

@app.route('/')
def index():
    return "æ–‡å­—æ±Ÿæ¹–éŠæˆ²å¾Œç«¯å·²å•Ÿå‹•ï¼"

@app.route('/api/generate_turn', methods=['POST'])
def generate_turn():
    """
    æ¥æ”¶ç©å®¶è¡Œå‹•ï¼Œå‘¼å« AI ç”Ÿæˆä¸‹ä¸€å›åˆå…§å®¹ï¼Œä¸¦æ›´æ–°è³‡æ–™åº«ã€‚
    """
    if not db:
        return jsonify({"error": "è³‡æ–™åº«æœå‹™æœªåˆå§‹åŒ–ï¼Œç„¡æ³•è™•ç†è«‹æ±‚ã€‚"}), 500

    try:
        # 1. å¾å‰ç«¯è«‹æ±‚ä¸­ç²å–ç©å®¶è¡Œå‹•
        data = request.get_json()
        player_action = data.get('player_action')
        if not player_action:
            return jsonify({"error": "è«‹æ±‚ä¸­æœªåŒ…å«ç©å®¶è¡Œå‹• 'player_action'"}), 400

        # (æœªä¾†æ­¥é©Ÿ) 2. å¾ Firebase è®€å–ç•¶å‰çš„éŠæˆ²ä¸–ç•Œç‹€æ…‹
        # game_state_ref = db.collection('games').document('game_session_main')
        # current_world_state = game_state_ref.get().to_dict()
        # if not current_world_state:
        #     # å¦‚æœæ²’æœ‰å­˜æª”ï¼Œå¯ä»¥å‰µå»ºä¸€å€‹åˆå§‹ç‹€æ…‹
        #     current_world_state = {"story_log": "éŠæˆ²é–‹å§‹..."} # ç¯„ä¾‹

        # 3. æº–å‚™å‘¼å« DeepSeek AI
        api_key = os.environ.get('DEEPSEEK_API_KEY')
        if not api_key:
            return jsonify({"error": "DeepSeek API Key æœªè¨­å®šã€‚"}), 500

        headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json"
        }

        # å»ºç«‹ä¸€å€‹å¼·å¤§çš„ç³»çµ±æç¤ºï¼ŒæŒ‡å° AI çš„è¡Œç‚º
        system_prompt = """
        ä½ æ˜¯æ–‡å­—RPGéŠæˆ²ã€Šæ–‡å­—æ±Ÿæ¹–ï¼šé»‘é¢¨å¯¨å´›èµ·ã€‹çš„éŠæˆ²ç®¡ç†å“¡(Game Master)ã€‚
        ä½ çš„è·è²¬æ˜¯æ ¹æ“šç©å®¶çš„é¸æ“‡ï¼ŒåŸºæ–¼å·²æœ‰çš„ä¸–ç•Œè§€ã€è§’è‰²æ•¸æ“šå’ŒåŠ‡æƒ…æ¨¡çµ„ï¼Œç”Ÿæˆä¸‹ä¸€å›åˆçš„éŠæˆ²å…§å®¹ã€‚
        ä½ çš„å›æ‡‰å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹è¦å‰‡ï¼š
        1. æ ¼å¼ï¼šå®Œå…¨éµå¾ª 'é‡è¦_ğŸ“‘ æ¯å›åˆæ ¼å¼æ’ç‰ˆè¦å‰‡ (standard_round_log_template.ml).ini' æª”æ¡ˆä¸­å®šç¾©çš„æ ¼å¼ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„å€å¡Šã€‚
        2. ä¸–ç•Œè§€ï¼šæ‰€æœ‰æè¿°ã€ç”¨è©ã€å–®ä½å’Œæƒ…ç¯€éƒ½å¿…é ˆç¬¦åˆ 'AI GM æŒ‡ä»¤ - æ ¸å¿ƒä¸–ç•Œè§€è¨­å®š.txt' ä¸­çš„é‡‘åº¸æ­¦ä¿ é¢¨æ ¼ã€‚
        3. é‚è¼¯ï¼šæ‰€æœ‰äº‹ä»¶çš„ç™¼ç”Ÿéƒ½å¿…é ˆç¬¦åˆéŠæˆ²çš„å…§éƒ¨é‚è¼¯ï¼Œä¸å¯æ†‘ç©ºç”¢ç”Ÿæˆ–é•èƒŒç‰©ç†å¸¸è­˜ã€‚
        4. æ•¸æ“šé©…å‹•ï¼šNPC çš„åæ‡‰ã€æŠ€èƒ½çš„åˆ¤å®šã€è³‡æºçš„è®ŠåŒ–éƒ½æ‡‰åŸºæ–¼å…¶èƒŒå¾Œçš„æ•¸æ“šï¼ˆé›–ç„¶ä½ ä¸éœ€è¦ç›´æ¥å±•ç¤ºæ•¸å€¼ï¼‰ã€‚
        5. åŠ‡æƒ…æ¨é€²ï¼šæ ¹æ“šç©å®¶çš„è¡Œå‹•ï¼Œè‡ªç„¶åœ°æ¨é€²åŠ‡æƒ…ï¼Œä¸¦åœ¨å›åˆçµæŸæ™‚æä¾› 3-5 å€‹åˆä¹æƒ…ç†çš„è¡Œå‹•é¸é …ã€‚
        """

        # (æœªä¾†æ­¥é©Ÿ) é€™è£¡å¯ä»¥å°‡ current_world_state çš„æ‘˜è¦ä¹ŸåŠ å…¥åˆ°æç¤ºä¸­
        # user_prompt = f"ç•¶å‰ä¸–ç•Œç‹€æ…‹æ‘˜è¦ï¼š{current_world_state['story_log'][-5:]}\n\nç©å®¶é¸æ“‡çš„è¡Œå‹•æ˜¯ï¼š'{player_action}'ã€‚\n\nè«‹ç”Ÿæˆä¸‹ä¸€å›åˆçš„å®Œæ•´å…§å®¹ã€‚"

        # ç›®å‰ç°¡åŒ–ç‰ˆçš„ä½¿ç”¨è€…æç¤º
        user_prompt = f"ç©å®¶é¸æ“‡çš„è¡Œå‹•æ˜¯ï¼š'{player_action['text']}' (ID: {player_action['id']})ã€‚\n\nè«‹æ ¹æ“šé€™å€‹è¡Œå‹•ï¼Œç”Ÿæˆä¸‹ä¸€å›åˆçš„å®Œæ•´éŠæˆ²å…§å®¹ã€‚"

        payload = {
            "model": "deepseek-chat",
            "messages": [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            "stream": False # ç¢ºä¿ä¸€æ¬¡æ€§è¿”å›å®Œæ•´å…§å®¹
        }

        # 4. ç™¼é€è«‹æ±‚çµ¦ DeepSeek
        response = requests.post(DEEPSEEK_API_URL, headers=headers, json=payload)
        response.raise_for_status()  # å¦‚æœè«‹æ±‚å¤±æ•— (e.g., 4xx, 5xx)ï¼Œæœƒæ‹‹å‡ºç•°å¸¸
        
        ai_response_data = response.json()
        next_turn_content = ai_response_data['choices'][0]['message']['content']

        # (æœªä¾†æ­¥é©Ÿ) 5. è§£æ AI å›æ‡‰ï¼Œæ›´æ–°éŠæˆ²ä¸–ç•Œç‹€æ…‹ä¸¦å­˜å› Firebase
        # new_world_state = parse_ai_response_and_update_state(current_world_state, next_turn_content)
        # game_state_ref.set(new_world_state)

        # 6. å°‡ AI ç”Ÿæˆçš„ä¸‹ä¸€å›åˆå…§å®¹è¿”å›çµ¦å‰ç«¯
        return jsonify({"narrative": next_turn_content})

    except requests.exceptions.RequestException as e:
        return jsonify({"error": f"å‘¼å« AI æœå‹™å¤±æ•—: {e}"}), 503
    except Exception as e:
        print(f"ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤: {e}")
        return jsonify({"error": "ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤ã€‚"}), 500

if __name__ == '__main__':
    # é€™å…è¨±æˆ‘å€‘åœ¨æœ¬åœ°ç›´æ¥é‹è¡Œä»¥é€²è¡Œæ¸¬è©¦
    # Render æœƒä½¿ç”¨ Gunicorn ä¾†å•Ÿå‹•ï¼Œè€Œä¸æ˜¯ç›´æ¥é‹è¡Œé€™å€‹æª”æ¡ˆ
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 8080)))
