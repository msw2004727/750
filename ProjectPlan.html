<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 驅動文字遊戲 - 專案開發白皮書</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f8f9fa;
        }
        .dark body {
            background-color: #1a202c;
        }
        .tab-btn {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #4a5568;
        }
        .dark .tab-btn {
            color: #a0aec0;
        }
        .tab-btn.active {
            color: #4299e1;
            border-bottom-color: #4299e1;
        }
        .dark .tab-btn.active {
            color: #63b3ed;
            border-bottom-color: #63b3ed;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-content.active {
            display: block;
        }
        .prose h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }
        .dark .prose h3 {
            border-bottom-color: #4a5568;
        }
        .prose h4 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .prose blockquote {
            border-left: 4px solid #a0aec0;
            padding: 0.5rem 1rem;
            background-color: #edf2f7;
            margin: 1rem 0;
        }
        .dark .prose blockquote {
            border-left-color: #4a5568;
            background-color: #2d3748;
        }
        .prose code {
            background-color: #edf2f7;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
        }
        .dark .prose code {
            background-color: #2d3748;
        }
        .prose pre {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .status-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        .status-completed { background-color: #c6f6d5; color: #2f855a; }
        .status-inprogress { background-color: #faf089; color: #b7791f; }
        .status-planned { background-color: #bee3f8; color: #2b6cb0; }
        .dark .status-completed { background-color: #2f855a; color: #c6f6d5; }
        .dark .status-inprogress { background-color: #b7791f; color: #faf089; }
        .dark .status-planned { background-color: #2b6cb0; color: #bee3f8; }
    </style>
</head>
<body class="dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-gray-900 dark:text-white">AI 驅動文字遊戲</h1>
            <p class="text-xl text-gray-500 dark:text-gray-400 mt-4">專案開發白皮書 (v1.0)</p>
        </header>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl">
            <!-- 頁籤導覽 -->
            <nav class="flex flex-wrap border-b border-gray-200 dark:border-gray-700 px-6">
                <button class="tab-btn active" data-tab="roadmap">開發藍圖</button>
                <button class="tab-btn" data-tab="qanda">系統設計 Q&A</button>
                <button class="tab-btn" data-tab="tech_stack">技術堆疊</button>
                <button class="tab-btn" data-tab="file_structure">檔案結構</button>
            </nav>

            <!-- 頁籤內容 -->
            <main class="p-6 sm:p-8">
                <!-- 開發藍圖 -->
                <div id="roadmap" class="tab-content active prose max-w-none">
                    <h3>短期目標 (Next Up)：遊戲體驗打磨與 AI 調教</h3>
                    <p>此階段的核心是「提升沉浸感」。我們不開發大型新功能，而是專注於優化現有系統，讓 AI 的行為更真實、更符合世界觀，並讓玩家的互動體驗更流暢。</p>
                    
                    <h4>核心任務</h4>
                    <ul class="space-y-4">
                        <li>
                            <div class="flex items-center justify-between">
                                <strong>混合驅動式物品互動</strong>
                                <span class="status-tag status-planned">計畫中</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">目標：解決目前撿拾/丟棄物品完全依賴 AI 理解的痛點。將在故事敘述中的物品文字轉為可點擊的互動元素，並提供明確的「撿起」、「查看」等按鈕，讓玩家的意圖能被精準執行。</p>
                        </li>
                        <li>
                            <div class="flex items-center justify-between">
                                <strong>細化旅行隨機事件</strong>
                                <span class="status-tag status-planned">計畫中</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">目標：讓旅行過程本身充滿故事。後端將根據道路的 `travel_risk`（高/中/低）來決定觸發隨機事件的機率，並將此情境告知 AI，由 AI 生成具體的遭遇（例如：遇到商人、被野獸襲擊、發現廢棄神廟等）。</p>
                        </li>
                         <li>
                            <div class="flex items-center justify-between">
                                <strong>AI 環境感知</strong>
                                <span class="status-tag status-planned">計畫中</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">目標：讓 AI 的敘事更貼近世界狀態。在 Prompt 中強化對 `currentTime` (時辰) 和 `currentWeather` (天氣) 的描述，要求 AI 的故事氛圍、NPC 行為和事件必須與環境保持一致。</p>
                        </li>
                        <li>
                            <div class="flex items-center justify-between">
                                <strong>已完成的核心功能</strong>
                                <span class="status-tag status-completed">已完成</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">基礎建設、核心遊戲迴圈、迷霧系統、動態世界事件、地圖與旅行系統、以及最關鍵的**原子性存檔機制**皆已完成，為當前的打磨工作奠定了穩固的基礎。</p>
                        </li>
                    </ul>

                    <h3>中期目標 (Future)：玩法擴充與世界深化</h3>
                    <p>在核心體驗打磨完成後，我們將開始為遊戲增添更多血肉，引入更多元的系統，大幅提升遊戲的可玩性與深度。</p>
                     <ul class="space-y-4">
                        <li>
                            <div class="flex items-center justify-between">
                                <strong>動態任務系統</strong>
                                <span class="status-tag status-planned">計畫中</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">目標：讓 AI 不僅能創造 NPC 和地點，更能主動生成有始有終的任務線，並讓玩家可以透過 UI 追蹤任務進度。</p>
                        </li>
                         <li>
                            <div class="flex items-center justify-between">
                                <strong>角色成長系統</strong>
                                <span class="status-tag status-planned">計畫中</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">目標：引入更明確的屬性與技能系統。玩家的行為不僅會影響故事，也會累積經驗並提升相應技能（如：常說服 NPC 會提升「口才」），AI 在進行成功率判定時需要參考這些數值。</p>
                        </li>
                    </ul>

                    <h3>長期願景 (Vision)：永續演化的動態世界</h3>
                     <ul class="space-y-4">
                        <li>
                             <div class="flex items-center justify-between">
                                <strong>AI 自主 NPC</strong>
                                <span class="status-tag status-planned">計畫中</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">目標：讓世界中的 NPC 擁有自己的「人生目標」和「每日行程」。即使玩家不在場，他們也會根據自己的設定去行動，進而影響世界狀態，讓世界真正「活」起來。</p>
                        </li>
                        <li>
                             <div class="flex items-center justify-between">
                                <strong>多人非同步互動</strong>
                                <span class="status-tag status-planned">計畫中</span>
                            </div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">目標：實現玩家間的非同步互動。例如，玩家 A 留下的「一封信」或建立的「一個新商會」，可以被後來的玩家 B 發現並產生互動，真正實現「共創世界」的理念。</p>
                        </li>
                    </ul>
                </div>

                <!-- 系統設計 Q&A -->
                <div id="qanda" class="tab-content prose max-w-none">
                    <h3>核心系統設計問答 (for Developers)</h3>
                    <p>本章節旨在為新加入的開發者快速解釋遊戲核心系統的運作原理與設計理念。</p>
                    
                    <h4>Q: 遊戲進度是如何儲存的？為何如此設計？</h4>
                    <blockquote>
                        <p><strong>答：採用「事務性原子更新」機制。</strong></p>
                        <p>所有會影響玩家進度的資料庫寫入操作，都被封裝在 <code>state_manager.py</code> 的 <code>update_game_state_in_transaction</code> 函式中。此函式使用了 Firestore 的 <code>@transactional</code> 裝飾器。</p>
                        <p><strong>設計理念：</strong> 為了保證資料的絕對一致性。一個玩家行動可能同時觸發多個狀態改變（如：位置移動、時間流逝、健康減少、獲得物品）。事務能確保這些操作要麼「全部成功寫入」，要麼在任一環節出錯時「全部回滾」，從根本上杜絕了「扣了藥水卻沒加血」這類資料不一致的惡性 Bug。</p>
                    </blockquote>

                    <h4>Q: 玩家的「旅行」是如何實現的？與 AI 的關係是？</h4>
                    <blockquote>
                        <p><strong>答：採用「規則為主，AI為輔」的混合模式。</strong></p>
                        <ol>
                            <li><strong>地圖規則：</strong> 資料庫 <code>locations</code> 集合中的每份文件，都明確定義了其出口 (<code>connections</code>)，包含目的地、距離和風險。這是旅行的「硬規則」。</li>
                            <li><strong>AI 生成選項：</strong> <code>prompt_generator.py</code> 會將當前地點的出口資訊提供給 AI，並要求 AI **必須**根據這些資訊生成移動選項。</li>
                            <li><strong>後端覆寫：</strong> 當玩家選擇了一個移動選項，<code>game_service.py</code> 會進行判斷。如果確認是移動指令，它會**跳過**再次呼叫 AI 來決定結果，而是直接根據地圖規則（距離、目的地）來呼叫 <code>state_manager.py</code> 更新玩家狀態。</li>
                        </ol>
                        <p><strong>設計理念：</strong> 將世界的「物理規則」（地圖連接）與 AI 的「敘事能力」分離。這樣既保證了玩家的移動永遠符合地圖邏輯，不會出現瞬移，又能讓 AI 專注於描述旅途中的風景與氛圍，各司其職。</p>
                    </blockquote>

                    <h4>Q: 玩家如何與物品互動 (撿拾/丟棄)？目前的瓶頸是？</h4>
                    <blockquote>
                        <p><strong>答：目前處於「純敘事驅動」的第一階段。</strong></p>
                        <p>玩家與物品的互動，完全依賴 AI 是否在故事中描述了某物品，並給出了對應的選項（如「撿起地上的石頭」）。玩家也可以手動輸入指令，但成功與否取決於 AI 的理解能力。</p>
                        <p><strong>瓶頸與下一步計畫：</strong> 這種方式給予玩家的直接掌控感較弱，且充滿不確定性。如「開發藍圖」中所述，我們的下一個核心目標就是實作「**混合驅動式物品互動系統**」，在敘事文字上附加可點擊的互動按鈕，將玩家的明確意圖（如「撿起」）與 AI 的敘事能力結合起來。</p>
                    </blockquote>

                     <h4>Q: 我們如何控制 AI，避免它生成不合邏輯的內容？</h4>
                    <blockquote>
                        <p><strong>答：我們不「控制」AI，而是「引導」AI。</strong></p>
                        <p>我們的核心理念是將 AI 視為一位需要清晰「劇本」和「規則」的演員，而不是一個全知的上帝。我們主要透過以下方式引導它：</p>
                        <ul>
                            <li><strong>結構化情境 (Context)：</strong> <code>prompt_generator.py</code> 的核心工作，就是將遊戲的即時狀態（時間、地點、天氣、玩家狀態、地圖出口）轉換成 AI 能理解的、清晰的結構化文字。</li>
                            <li><strong>明確的指令模板 (Template)：</strong> <code>prompt_templates.py</code> 中定義了 AI 的任務、規則和輸出格式。我們明確告知它必須遵循世界觀、必須參考地圖出口、必須以 JSON 格式回傳。</li>
                            <li><strong>給予範例 (Few-shot Learning)：</strong> 在指令中提供一至多個完整的「輸入-輸出」範例，是引導 AI 穩定輸出正確格式的最有效方法之一。</li>
                        </ul>
                        <p><strong>設計理念：</strong> 我們的系統並非在 AI 失控後進行「審查」，而是在一開始就提供足夠的「護欄」和「指引」，讓 AI 在一個我們設定好的框架內進行創作，從而最大化其創造力，同時最小化其不可預測性。</p>
                    </blockquote>
                </div>

                <!-- 技術堆疊 -->
                <div id="tech_stack" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-2xl font-bold mb-4">後端 (Backend)</h3>
                            <ul class="space-y-3">
                                <li class="flex items-center"><span class="font-bold w-32">主要語言:</span> <span>Python 3.11+</span></li>
                                <li class="flex items-center"><span class="font-bold w-32">API 框架:</span> <span>FastAPI</span></li>
                                <li class="flex items-center"><span class="font-bold w-32">伺服器:</span> <span>Uvicorn</span></li>
                                <li class="flex items-center"><span class="font-bold w-32">資料庫:</span> <span>Google Firebase Firestore</span></li>
                                <li class="flex items-center"><span class="font-bold w-32">部署平台:</span> <span>Render</span></li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold mb-4">前端 (Frontend)</h3>
                            <ul class="space-y-3">
                                <li class="flex items-center"><span class="font-bold w-32">核心技術:</span> <span>HTML5, CSS3, JavaScript (ES6 Modules)</span></li>
                                <li class="flex items-center"><span class="font-bold w-32">CSS 框架:</span> <span>Tailwind CSS</span></li>
                                <li class="flex items-center"><span class="font-bold w-32">互動套件:</span> <span>SortableJS (用於儀表板拖曳)</span></li>
                            </ul>
                        </div>
                         <div class="md:col-span-2">
                            <h3 class="text-2xl font-bold mb-4 mt-8">核心 AI 服務</h3>
                            <ul class="space-y-3">
                                <li class="flex items-center"><span class="font-bold w-32">模型提供商:</span> <span>DeepSeek / OpenAI (可透過環境變數切換)</span></li>
                                <li class="flex items-center"><span class="font-bold w-32">主要職責:</span> <span>動態生成故事敘述、玩家選項、世界演化與創造</span></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 檔案結構 -->
                <div id="file_structure" class="tab-content">
                    <div class="prose max-w-none">
                        <h3>檔案結構支狀圖</h3>
                        <p>此結構圖展示了專案目前的完整樣貌，以及每個關鍵檔案的核心用途。</p>
                        <pre><code>專案根目錄/
├── backend/                  # 後端 Python 專案目錄
│   ├── app/                  # FastAPI 應用程式主要程式碼
│   │   ├── api/              # API 相關程式碼
│   │   │   └── v1/           # API 版本 v1
│   │   │       └── endpoints/  # API 端點 (處理網頁請求)
│   │   │           ├── admin.py     # 管理員用 API (例如: 填充資料庫)
│   │   │           └── game.py      # 遊戲核心 API (例如: 獲取狀態、執行動作)
│   │   ├── core/             # 核心設定與組態
│   │   │   ├── config.py      # 環境變數設定 (例如: API 金鑰)
│   │   │   └── firebase_config.py # Firebase 資料庫連線設定
│   │   ├── models/           # Pydantic 資料模型 (定義資料結構)
│   │   │   ├── action.py    # 定義玩家行動的資料格式
│   │   │   ├── player.py    # 定義玩家角色的完整資料結構
│   │   │   └── world.py     # 定義世界狀態的資料格式
│   │   ├── services/         # 商業邏輯服務層 (執行核心功能)
│   │   │   ├── ai_service.py      # AI 服務 (與 DeepSeek/OpenAI 溝通)
│   │   │   ├── game_service.py    # 遊戲核心流程總指揮
│   │   │   ├── prompt_generator.py # AI Prompt 產生器
│   │   │   ├── prompt_templates.py # AI Prompt 指令模板庫
│   │   │   ├── seed_service.py    # 初始資料填充服務
│   │   │   └── state_manager.py   # 遊戲狀態存檔管理器 (核心)
│   │   └── main.py           # FastAPI 應用程式進入點
│   └── requirements.txt      # Python 依賴套件列表
│
├── components/               # 前端 UI 元件 (可重複使用的 HTML 片段)
│   ├── actions.html          # 玩家行動區塊
│   ├── header.html           # 頁首
│   ├── modals.html           # 所有彈出視窗
│   ├── narrative.html        # 故事敘述區塊
│   ├── panel-player.html     # 儀表板 - 玩家狀態
│   ├── panel-quests.html     # 儀表板 - 任務
│   ├── panel-world.html      # 儀表板 - 世界資訊
│   └── scene-info.html       # 場景資訊
│
├── css/                      # CSS 樣式表
│   └── main.css              # 主要樣式與深色/淺色主題
│
├── js/                       # JavaScript 腳本
│   ├── api.js                # 前端 API 模組 (與後端溝通)
│   ├── dashboard.js          # 儀表板功能 (拖曳、收合)
│   ├── event-listeners.js    # 事件監聽器 (處理點擊互動)
│   ├── main.js               # 前端主程式進入點
│   ├── modals.js             # 彈出視窗開關邏輯
│   ├── render.js             # 畫面渲染模組 (將資料轉為 HTML)
│   ├── theme.js              # 主題切換功能
│   ├── ui.js                 # UI 更新總協調者
│   └── utils.js              # 可共用的工具函式
│
├── index.html                # 遊戲主頁面 (HTML 骨架)
└── ProjectPlan.html          # 專案開發白皮書 (本檔案)
</code></pre>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tabs = document.querySelectorAll('.tab-btn');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    // Remove active state from all tabs and content
                    tabs.forEach(item => item.classList.remove('active'));
                    contents.forEach(item => item.classList.remove('active'));
                    
                    // Add active state to the clicked tab and corresponding content
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            });
        });
    </script>
</body>
</html>
