// Ê™îÊ°à: assets/js/main.js
// ÁâàÊú¨: 5.3 (ÂÑÄË°®Êùø‰ΩàÂ±ÄÁâà)
// ÊèèËø∞: ÈáçÊßãUIÊõ¥Êñ∞ÈÇèËºØÔºåÂ∞áÊèêÁ§∫Ë≥áË®äÂàÜÈõ¢Âà∞ÂÑÄË°®ÊùøÔºå‰∏¶ÂïüÁî®ÊâÄÊúâÂèØÊî∂Êë∫Èù¢Êùø„ÄÇ

// --- Ë®≠ÂÆöËàá API URL ---
const API_BASE_URL = "https://md-server-main.onrender.com";
const TURN_URL = `${API_BASE_URL}/api/generate_turn`;
const ENTITY_INFO_URL = `${API_BASE_URL}/api/get_entity_info`;
const SUMMARY_URL = `${API_BASE_URL}/api/get_summary`;
const currentGameSessionId = localStorage.getItem('game_session_id');

// --- DOM ÂÖÉÁ¥†Áç≤Âèñ ---
const loadingOverlay = document.getElementById('loading-overlay');
const loadingText = document.getElementById('loading-text');
const narrativeLog = document.getElementById('narrative-log');
const actionOptionsContainer = document.getElementById('action-options');
const promptQuestion = document.getElementById('prompt-question');
const customActionForm = document.getElementById('custom-action-form');
const customActionInput = document.getElementById('custom-action-input');
const logoutBtn = document.getElementById('logout-btn-corner');

// Êñ∞‰ΩàÂ±ÄÂÖÉÁ¥†
const roundTitleEl = document.getElementById('round-title');
const systemPromptBox = document.getElementById('system-prompt-box');
const perceptionPromptBox = document.getElementById('perception-prompt-box');
const coreSituationBox = document.getElementById('core-situation-box');

// ËßíËâ≤ÁãÄÊÖã
const sidePlayerName = document.getElementById('player-name');
const sideHpBar = document.getElementById('hp-bar-side');
const sideMpBar = document.getElementById('mp-bar-side');
const sidePlayerHp = document.getElementById('player-hp');
const sidePlayerMp = document.getElementById('player-mp');

// ‰∏ñÁïåÁãÄÊÖã
const sideInfoLocation = document.getElementById('info-location');
const sideInfoTime = document.getElementById('info-time');
const sideInfoTimeReadable = document.getElementById('info-time-readable');
const sideWeather = document.getElementById('weather-info-desktop');
const sideTemp = document.getElementById('temperature-info');
const sideHumidity = document.getElementById('humidity-info');

// Âè≥ÂÅ¥ÈÇäÊ¨Ñ
const sideSceneCharactersList = document.getElementById('scene-characters-list');
const sceneDesc = document.getElementById('scene-desc');
const sceneSize = document.getElementById('scene-size');
const scenePopulation = document.getElementById('scene-population');

// Modal Áõ∏ÈóúÂÖÉÁ¥†
const modal = document.getElementById('info-modal');
const modalCloseBtn = document.getElementById('modal-close-btn');
const modalTitle = document.getElementById('modal-title');
const modalBody = document.getElementById('modal-body');

let latestGameState = {};

// --- Ê†∏ÂøÉÂäüËÉΩÂáΩÊï∏ ---

function showLoading(text) {
    if (loadingOverlay) {
        loadingText.textContent = text;
        loadingOverlay.classList.remove('hidden');
    }
}

function hideLoading() {
    if (loadingOverlay) {
        loadingOverlay.classList.add('hidden');
    }
}

function getReadableTime(gameTimestamp) {
    if (!gameTimestamp) return { full: "---", readable: "" };
    const timePart = gameTimestamp.split(' ')[1] || '';
    const hourMap = { 'Â≠ê':'23-01', '‰∏ë':'01-03', 'ÂØÖ':'03-05', 'ÂçØ':'05-07', 'Ëæ∞':'07-09', 'Â∑≥':'09-11', 'Âçà':'11-13', 'Êú™':'13-15', 'Áî≥':'15-17', 'ÈÖâ':'17-19', 'Êàå':'19-21', '‰∫•':'21-23' };
    const hourMatch = timePart.match(/([Â≠ê‰∏ëÂØÖÂçØËæ∞Â∑≥ÂçàÊú™Áî≥ÈÖâÊàå‰∫•])ÊôÇ/);
    let readable = "";
    if (hourMatch && hourMap[hourMatch[1]]) {
        readable = `(Á¥Ñ ${hourMap[hourMatch[1]]}ÊôÇ)`;
    }
    return { full: gameTimestamp, readable: readable };
}


function updateUI(data) {
    const { narrative, state } = data;
    const { pc_data = {}, world = {}, metadata = {} } = state;
    const { npcs = {}, locations = {} } = pc_data; // ‰øÆÊ≠£: npcs Âíå locations ÂèØËÉΩÂú® pc_data ‰πãÂ§ñ

    // --- Êõ¥Êñ∞ËßíËâ≤ÁãÄÊÖã ---
    if(sidePlayerName) sidePlayerName.textContent = pc_data.basic_info?.name ?? '---';
    const hpPercent = (pc_data.core_status?.hp?.current / pc_data.core_status?.hp?.max) * 100 || 0;
    const mpPercent = (pc_data.core_status?.mp?.current / pc_data.core_status?.mp?.max) * 100 || 0;
    if(sideHpBar) sideHpBar.style.width = `${hpPercent}%`;
    if(sideMpBar) sideMpBar.style.width = `${mpPercent}%`;
    if(sidePlayerHp) sidePlayerHp.textContent = `${pc_data.core_status?.hp?.current ?? '--'}/${pc_data.core_status?.hp?.max ?? '--'}`;
    if(sidePlayerMp) sidePlayerMp.textContent = `${pc_data.core_status?.mp?.current ?? '--'}/${pc_data.core_status?.mp?.max ?? '--'}`;

    // --- Êõ¥Êñ∞‰∏ñÁïåÁãÄÊÖã ---
    const timeInfo = getReadableTime(metadata?.game_timestamp);
    if(sideInfoLocation) sideInfoLocation.textContent = world.player_current_location_name ?? 'Êú™Áü•';
    if(sideInfoTime) sideInfoTime.textContent = timeInfo.full;
    if(sideInfoTimeReadable) sideInfoTimeReadable.textContent = timeInfo.readable;
    const weatherEmojiMap = { "Êô¥": "‚òÄÔ∏è", "Èô∞": "‚òÅÔ∏è", "Èõ®": "üåßÔ∏è", "Èõ™": "‚ùÑÔ∏è", "Èúß": "üå´Ô∏è" };
    if(sideWeather) sideWeather.textContent = `${weatherEmojiMap[world.weather] || ''} ${world.weather || ''}`;
    if(sideTemp) sideTemp.textContent = world.temperature ?? '--';
    if(sideHumidity) sideHumidity.textContent = world.humidity ?? '--';

    // --- Êõ¥Êñ∞Âè≥ÂÅ¥ÈÇäÊ¨Ñ ---
    if(sideSceneCharactersList){
        const playerLocationId = world.player_current_location_id;
        const charactersInScene = Object.values(state.npcs || {}).filter(npc => npc.current_location_id === playerLocationId);
        sideSceneCharactersList.innerHTML = charactersInScene.length > 0
            ? charactersInScene.map(npc => `<li class="narrative-entity" data-entity-type="npc" data-entity-id="${npc.id}">${npc.alias || npc.name}</li>`).join('')
            : '<li>Ê≠§Âú∞Á©∫ÁÑ°‰∏Ä‰∫∫„ÄÇ</li>';
    }
    const currentLocation = state.locations ? state.locations[world.player_current_location_id] : {};
    if (currentLocation) {
        if(sceneDesc) sceneDesc.textContent = currentLocation.description || "Êé¢Á¥¢‰∏≠...";
        if(sceneSize) sceneSize.textContent = currentLocation.size || "Êú™Áü•";
        if(scenePopulation) scenePopulation.textContent = currentLocation.population || "Êú™Áü•";
    }

    // --- Ê†∏ÂøÉ‰øÆÊîπÔºöÂàÜÈõ¢‰∏¶Ê∏≤ÊüìÂäáÊÉÖËàáÊèêÁ§∫ ---
    let fullNarrativeText = (narrative || []).map(part => part.content || part.text).join('\n');
    
    const optionsRegex = /<options>([\s\S]*?)<\/options>/;
    const optionsMatch = fullNarrativeText.match(optionsRegex);
    const optionsContent = optionsMatch ? optionsMatch[1].trim() : '';
    fullNarrativeText = fullNarrativeText.replace(optionsRegex, '').trim();

    const prompts = {
        system: { regex: /\[„Äê‚öôÔ∏è Á≥ªÁµ±ÊèêÁ§∫„Äë([\s\S]*?)\]/g, el: systemPromptBox },
        perception: { regex: /\[„Äêüß† ÊÑüÁü•ÊèêÁ§∫„Äë([\s\S]*?)\]/g, el: perceptionPromptBox },
        situation: { regex: /„Äê\*\*Ê†∏ÂøÉËôïÂ¢É\*\*„Äë([\s\S]*)/g, el: coreSituationBox }
    };

    for (const key in prompts) {
        const { regex, el } = prompts[key];
        const matches = [...fullNarrativeText.matchAll(regex)];
        if (matches.length > 0 && el) {
            el.innerHTML = matches.map(match => match[1].trim()).join('<br>');
            el.classList.remove('hidden');
            fullNarrativeText = fullNarrativeText.replace(regex, '');
        } else if (el) {
            el.classList.add('hidden');
        }
    }
    
    const titleRegex = /„Äê\*\*(.*?)\*\*„Äë/;
    const titleMatch = fullNarrativeText.match(titleRegex);
    if (roundTitleEl && titleMatch) {
        roundTitleEl.textContent = `ÂõûÂêà ${metadata.round || '??'}: ${titleMatch[1]}`;
        fullNarrativeText = fullNarrativeText.replace(titleRegex, '').trim();
    } else if (roundTitleEl) {
        roundTitleEl.textContent = `ÂõûÂêà ${metadata.round || '??'}`;
    }

    if(narrativeLog) {
        narrativeLog.innerHTML = `<p>${fullNarrativeText.trim().replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>')}</p>`;
    }

    if (actionOptionsContainer) {
        actionOptionsContainer.innerHTML = '';
        promptQuestion.style.display = 'block';
        if (optionsContent) {
            const optionLineRegex = /^(?:[A-Z]|\d+)\..*$/m;
            const options = optionsContent.split('\n').filter(line => line.trim().match(optionLineRegex));
            options.forEach(opt => {
                const match = opt.trim().match(/^(?:([A-Z])|(\d+))\.\s*(.*)/);
                if(match){
                    const button = document.createElement('button');
                    button.dataset.actionId = match[1] || match[2];
                    button.textContent = match[3];
                    button.addEventListener('click', handleActionSelect);
                    actionOptionsContainer.appendChild(button);
                }
            });
        } else {
             promptQuestion.style.display = 'none';
        }
    }
}

async function handleActionSelect(event) {
    const button = event.currentTarget;
    const actionText = button.dataset.actionId === 'CUSTOM' ? button.textContent : button.textContent;
    showLoading("AI Ê≠£Âú®ÈÅãÁÆó‰∏≠...");

    try {
        const response = await fetch(TURN_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: currentGameSessionId,
                player_action: { id: button.dataset.actionId, text: actionText }
            })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP ÈåØË™§: ${response.status}`);
        }
        const data = await response.json();
        updateUI(data);
    } catch (error) {
        if(narrativeLog) narrativeLog.innerHTML += `<p style="color:red;">ÈåØË™§: ${error.message}</p>`;
    } finally {
        hideLoading();
    }
}

function handleCustomActionSubmit(event) {
    event.preventDefault();
    const actionText = customActionInput.value.trim();
    if (!actionText) return;
    handleActionSelect({ currentTarget: { dataset: {actionId: 'CUSTOM'}, textContent: actionText } });
    customActionInput.value = '';
}

function handleLogout() {
    if (confirm("Á¢∫ÂÆöË¶ÅÈÄÄÂá∫Ê±üÊπñÂóéÔºü")) {
        localStorage.removeItem('game_session_id');
        window.location.href = 'login.html';
    }
}

function toggleCollapse(event) {
    const title = event.currentTarget;
    const content = title.nextElementSibling;
    if (content && content.classList.contains('collapsible-content')) {
        title.classList.toggle('collapsed');
        content.classList.toggle('collapsed');
    }
}

// --- ÈÅäÊà≤ÂïüÂãï ---
document.addEventListener('DOMContentLoaded', async () => {
    if (!currentGameSessionId) {
        window.location.href = 'login.html';
        return;
    }
    
    // ‰∫ã‰ª∂Áõ£ËÅΩ
    if(logoutBtn) logoutBtn.addEventListener('click', handleLogout);
    if(customActionForm) customActionForm.addEventListener('submit', handleCustomActionSubmit);
    document.querySelectorAll('.collapsible-title').forEach(title => {
        title.addEventListener('click', toggleCollapse);
        // È†êË®≠Êî∂Âêà
        title.classList.add('collapsed');
        title.nextElementSibling.classList.add('collapsed');
    });
    
    // ÂàùÂßãËºâÂÖ•
    showLoading("ËºâÂÖ•Ê±üÊπñÂÇ≥Ë™™...");
    try {
        const turnResponse = await fetch(TURN_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: currentGameSessionId,
                player_action: { id: 'START', text: 'ÁπºÁ∫åÊóÖÁ®ã' }
            })
        });
        if (!turnResponse.ok) throw new Error((await turnResponse.json()).error);
        const turnResult = await turnResponse.json();
        updateUI(turnResult);

    } catch (error) {
        if(narrativeLog) narrativeLog.innerHTML = `<p style="color:red;">ÈÅäÊà≤ËºâÂÖ•Â§±Êïó: ${error.message}</p>`;
    } finally {
        hideLoading();
    }
});
