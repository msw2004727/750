<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>芽芽已婚群專屬試玩<審問遊戲></審問遊戲></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            overscroll-behavior-y: contain;
        }
        .card {
            background-color: #2d3748;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dialogue-area {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #4a5568;
            padding: 10px;
            border-radius: 8px;
            background-color: #1f2937;
            min-height: 200px;
        }
        .dialogue-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            max-width: 85%;
            word-wrap: break-word;
            color: white; 
        }
        .player-bubble {
            background-color: #4299e1; 
            margin-left: auto;
            text-align: right;
        }
        .player-bubble-calm {
            background-color: #38a169; 
        }
        .player-bubble-angry {
            background-color: #e53e3e; 
        }
        .player-bubble-provocative {
            background-color: #d69e2e; 
        }
        .officer-bubble { /* Officer's statements */
            background-color: #38a169; /* Calm tone color */
            color: white;
            margin-left: auto; /* Align right like player */
            text-align: right;
        }
        .ai-bubble {
            background-color: #4a5568;
            color: #e2e8f0;
            margin-right: auto;
        }
        .keyword, .case-keyword { /* Added .case-keyword for dynamically generated keywords */
            text-decoration: underline;
            color: #63b3ed;
            cursor: pointer;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 16px;
        }
        .modal-content {
            background-color: #2d3748;
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            max-width: 500px; 
            max-height: 90vh; 
            overflow-y: auto;
            text-align: left;
            color: #e2e8f0;
        }
        .modal-content.modal-lg {
            max-width: 600px;
        }
        .modal-content h3 {
            text-align: center;
            margin-bottom: 16px;
        }
        .story-summary-text {
            font-size: 0.8rem; 
        }
        .story-summary-divider {
            border-top: 1px solid #4a5568;
            margin: 12px 0;
        }
        .personality-block {
            background-color: #374151; 
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            border: 1px solid #4a5568;
        }
        #personality-modal {
            font-style: normal;
        }
        .tone-button {
            color: #e2e8f0;
            border: 1px solid #718096;
            flex-grow: 1;
            padding: 8px 0;
        }
        .tone-button-calm { background-color: #2c5282; } 
        .tone-button-calm.active { background-color: #3182ce; border-color: #3182ce; color:white;}

        .tone-button-angry { background-color: #9b2c2c; } 
        .tone-button-angry.active { background-color: #e53e3e; border-color: #e53e3e; color:white;}

        .tone-button-provocative { background-color: #975a16; } 
        .tone-button-provocative.active { background-color: #d69e2e; border-color: #d69e2e; color:white;}
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .game-main-area {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 20px); 
            padding: 8px;
        }
        #avatar {
            background-color: #4a5568; 
        }
        .interrogation-tip {
            font-size: 0.75rem; /* Smaller text */
            color: #a0aec0; /* Lighter gray */
            text-align: center;
            margin-top: 4px;
            padding: 4px;
            background-color: #2a303c; /* Slightly different background for the tip area */
            border-radius: 4px;
            min-height: 2.5em; /* Ensure space even if empty */
        }
    </style>
</head>
<body class="overscroll-y-contain">
    <div class="game-main-area container mx-auto">
        <header class="text-center mb-3">
            <h1 class="text-2xl sm:text-3xl font-bold text-blue-400">AI 審問遊戲</h1>
            <div class="flex justify-around text-sm sm:text-base mt-1">
                <p>🟢 回合數: <span id="round-count">0</span></p>
                <p>🗣️ 頑抗度: <span id="confession-meter-text">態度強硬</span></p>
            </div>
            <p class="text-xs mt-1" title="這是 Firebase 匿名認證為您的遊戲會話生成的唯一標識，用於保存遊戲進度。">您的 User ID: <span id="user-id-display">載入中...</span></p>
        </header>

        <div class="flex gap-3 mb-3">
            <div id="avatar" class="w-20 h-20 sm:w-24 sm:h-24 rounded-md flex-shrink-0 flex items-center justify-center text-gray-400 text-xs sm:text-sm p-1 text-center">
                頭像預留
            </div>
            <div id="suspect-status-card" class="flex-grow flex flex-col gap-2 card p-2 text-xs sm:text-sm">
                 <h2 class="text-sm sm:text-base font-semibold mb-1 text-blue-300 text-center">嫌犯狀態 (<span id="suspect-status-name"></span>)</h2>
                 <div id="suspect-status-details" class="grid grid-cols-2 gap-x-2 gap-y-1">
                    <p>📈<strong>心率:</strong> <span id="heart-rate">75</span> bpm</p>
                    <p>🩸<strong>血壓:</strong> <span id="blood-pressure">120/80</span></p>
                    <p>😠<strong>表情:</strong> <span id="facial-expression" class="italic">讀取中...</span></p>
                    <p>🧍<strong>肢體:</strong> <span id="body-language" class="italic">讀取中...</span></p>
                    <p>🤏<strong>微動作:</strong> <span id="micro-action" class="italic">讀取中...</span></p>
                    <p>🗣️<strong>語氣:</strong> <span id="voice-tone" class="italic">讀取中...</span></p>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3 mb-3">
            <button id="show-personal-details-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">👤 個人資料</button>
            <button id="show-story-summary-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded-md text-sm sm:text-base">📜 案件概要</button>
        </div>

        <div id="dialogue-area" class="dialogue-area mb-3"></div>
        
        <div class="interrogation-tip" id="interrogation-tip-area">
            ※ 偵訊提示載入中...
        </div>

        <div class="mt-auto pt-2"> <textarea id="player-input" class="w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base" rows="2" placeholder="輸入您的問題..."></textarea>
            <div class="mt-2 flex gap-1 sm:gap-2">
                <button class="tone-button tone-button-calm active rounded-md text-xs sm:text-sm" data-tone="平緩">😌 平緩</button>
                <button class="tone-button tone-button-angry rounded-md ml-1 text-xs sm:text-sm" data-tone="憤怒">😡 憤怒</button>
                <button class="tone-button tone-button-provocative rounded-md ml-1 text-xs sm:text-sm" data-tone="挑釁">😏 挑釁</button>
            </div>
             <button id="send-button" class="mt-2 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 text-sm sm:text-base">
                發送
            </button>
        </div>
    </div>

    <div id="personal-details-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-300">👤 嫌犯個人資料</h3>
            <div id="modal-personal-details-content">
                <p><strong>姓名:</strong> <span id="suspect-name-modal">李明</span></p>
                <p><strong>生日:</strong> <span id="dob-modal">讀取中...</span></p> <p><strong>星座:</strong> <span id="zodiac-modal">讀取中...</span></p>
                <p><strong>血型:</strong> <span id="blood-type-modal">讀取中...</span></p>
                <p><strong>年紀:</strong> <span id="age-modal">讀取中...</span></p>
                <p><strong>性別:</strong> <span id="gender-modal">讀取中...</span></p>
                <div class="personality-block">
                    <p class="font-semibold mb-1">🎭 個性概述:</p>
                    <p id="personality-modal" class="text-sm">讀取中...</p> 
                </div>
            </div>
            <button onclick="document.getElementById('personal-details-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">關閉</button>
        </div>
    </div>

    <div id="story-summary-modal" class="modal hidden">
        <div class="modal-content modal-lg"> 
            <h3 class="text-xl font-bold text-blue-300">📜 案件概要</h3>
            <div id="modal-story-summary-content" class="story-summary-text">
                <div>
                    <p class="font-semibold">被害人驗屍報告:</p>
                    <span id="autopsy-report-modal-content">讀取中...</span>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">對嫌犯不利的目前證據:</p>
                    <ul id="evidence-list-modal-content" class="list-disc list-inside ml-4"><li>讀取中...</li></ul>
                </div>
                <hr class="story-summary-divider">
                <div>
                    <p class="font-semibold mt-2">嫌犯調查疑點:</p>
                    <ul id="doubts-list-modal-content" class="list-disc list-inside ml-4"><li>讀取中...</li></ul>
                </div>
            </div>
            <button onclick="document.getElementById('story-summary-modal').classList.add('hidden')" class="mt-6 w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md">關閉</button>
        </div>
    </div>

    <div id="keyword-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="keyword-modal-title" class="text-xl font-bold text-blue-300">🔑 關鍵字補充</h3>
            <p id="keyword-modal-text">補充內容...</p>
            <div id="keyword-loading-spinner" class="loading-spinner my-4 hidden"></div>
            <button onclick="document.getElementById('keyword-modal').classList.add('hidden')" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md">關閉</button>
        </div>
    </div>

    <div id="game-over-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h3 id="game-over-title" class="text-2xl font-bold mb-4">⚖️ 審問結束</h3>
            <p>總共耗費回合數: <span id="total-rounds">0</span></p>
            <div class="mt-4 text-left">
                 <p class="font-semibold mb-2">心理攻防分析:</p>
                 <p id="game-analysis-text" class="text-sm whitespace-pre-wrap">分析中...</p>
            </div>
            <button id="restart-game-button" class="mt-6 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md">🔄 重新開始</button>
        </div>
    </div>
    
    <div id="ai-thinking-modal" class="modal hidden">
        <div class="modal-content text-center">
            <p class="text-lg">🤖 AI 正在思考回應...</p>
            <div class="loading-spinner my-4"></div>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, serverTimestamp, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM Elements
        const roundCountEl = document.getElementById('round-count');
        const confessionMeterTextEl = document.getElementById('confession-meter-text');
        const heartRateEl = document.getElementById('heart-rate');
        const bloodPressureEl = document.getElementById('blood-pressure');
        const facialExpressionEl = document.getElementById('facial-expression');
        const bodyLanguageEl = document.getElementById('body-language');
        const microActionEl = document.getElementById('micro-action');
        const voiceToneEl = document.getElementById('voice-tone');
        const suspectStatusNameEl = document.getElementById('suspect-status-name'); 
        const suspectNameModalEl = document.getElementById('suspect-name-modal');
        const dobModalEl = document.getElementById('dob-modal');
        const zodiacModalEl = document.getElementById('zodiac-modal');
        const bloodTypeModalEl = document.getElementById('blood-type-modal');
        const ageModalEl = document.getElementById('age-modal');
        const genderModalEl = document.getElementById('gender-modal');
        const personalityModalEl = document.getElementById('personality-modal');
        const autopsyReportModalContentEl = document.getElementById('autopsy-report-modal-content');
        const evidenceListModalContentEl = document.getElementById('evidence-list-modal-content');
        const doubtsListModalContentEl = document.getElementById('doubts-list-modal-content');
        const showPersonalDetailsButton = document.getElementById('show-personal-details-button');
        const showStorySummaryButton = document.getElementById('show-story-summary-button');
        const personalDetailsModal = document.getElementById('personal-details-modal');
        const storySummaryModal = document.getElementById('story-summary-modal');
        const dialogueAreaEl = document.getElementById('dialogue-area');
        const playerInputEl = document.getElementById('player-input');
        const sendButton = document.getElementById('send-button');
        const toneButtons = document.querySelectorAll('.tone-button');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const keywordModal = document.getElementById('keyword-modal');
        const keywordModalTitle = document.getElementById('keyword-modal-title');
        const keywordModalText = document.getElementById('keyword-modal-text');
        const keywordLoadingSpinner = document.getElementById('keyword-loading-spinner');
        const gameOverModal = document.getElementById('game-over-modal');
        const gameOverTitle = document.getElementById('game-over-title');
        const totalRoundsEl = document.getElementById('total-rounds');
        const gameAnalysisTextEl = document.getElementById('game-analysis-text'); 
        const restartGameButton = document.getElementById('restart-game-button');
        const aiThinkingModal = document.getElementById('ai-thinking-modal');
        const avatarEl = document.getElementById('avatar'); 
        const suspectStatusCardEl = document.getElementById('suspect-status-card'); 
        const interrogationTipAreaEl = document.getElementById('interrogation-tip-area');

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('error'); 

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'interrogation-game-default';
        let userId = null;
        let gameId = `game_${Date.now()}`; 
        let gameStateUnsubscribe = null; 

        function getDefaultGameState() {
            return {
                round: 0,
                confessionMeter: 100, 
                suspect: {
                    name: "未知嫌犯", 
                    dob: "", zodiac: "", bloodType: "", age: 0, gender: "",
                    personality: "讀取中...",
                    heartRate: 75, bloodPressure: "120/80", 
                    facialExpression: "讀取中...", bodyLanguage: "讀取中...", 
                    microAction: "讀取中...", voiceTone: "讀取中..."
                },
                caseDetails: { 
                    autopsyReport: "案件生成中...",
                    evidence: [], 
                    doubts: []    
                },
                dialogueHistory: [],
                selectedTone: "平緩",
                gameOver: false,
                gameAnalysis: "" 
            };
        }
        let gameState = getDefaultGameState();
        
        function getConfessionMeterText(percentage) { /* Unchanged */
            if (percentage > 80) return "態度強硬";
            if (percentage > 60) return "故作鎮定";
            if (percentage > 40) return "略顯動搖";
            if (percentage > 20) return "心虛慌亂";
            if (percentage > 0) return "瀕臨崩潰";
            return "已然認罪";
        }
        
        function adjustAvatarSize() { /* Unchanged */
            if (suspectStatusCardEl && avatarEl) {
                requestAnimationFrame(() => {
                    const height = suspectStatusCardEl.offsetHeight;
                    if (height > 0) {
                        avatarEl.style.height = `${height}px`;
                        avatarEl.style.width = `${height}px`; 
                    } else {
                        setTimeout(adjustAvatarSize, 100); 
                    }
                });
            }
        }

        async function initializeGame() { /* Unchanged */
             try {
                await setPersistence(auth, browserLocalPersistence);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication error:", error);
                if (error.code === 'auth/invalid-custom-token' || !auth.currentUser) {
                    try { await signInAnonymously(auth); } catch (anonError) {
                        console.error("Anonymous sign-in failed:", anonError);
                        userIdDisplayEl.textContent = "認證失敗"; return;
                    }
                }
            }
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplayEl.textContent = userId.substring(0,8) + "..."; 
                } else {
                    userId = `anon_${crypto.randomUUID()}`;
                    userIdDisplayEl.textContent = "匿名訪客";
                }
                await loadOrCreateNewGame(); 
            });
        }
        
        async function getGameDocRef() { /* Unchanged */
            if (!userId) {
                const tempGameId = `local_game_${Date.now()}`;
                return doc(db, "localGames", tempGameId);
            }
            return doc(db, "artifacts", appId, "users", userId, "interrogationGames", gameId);
        }
        
        const DEEPSEEK_API_KEY = "sk-19179bb0c0c94acaa53ca82dc1d28bbf"; 
        const DEEPSEEK_API_URL = "https://api.deepseek.com/chat/completions";

        function cleanAIJsonResponse(rawResponse) {
            if (typeof rawResponse !== 'string') return null; // Return null or throw error if not a string

            let str = rawResponse.trim();
            
            // Attempt to remove markdown fences specifically for JSON
            const jsonMatch = str.match(/```json\s*([\s\S]*?)\s*```/);
            if (jsonMatch && jsonMatch[1]) {
                return jsonMatch[1].trim();
            }

            // Attempt to remove generic markdown fences if ```json...``` was not found
            const genericMatch = str.match(/```\s*([\s\S]*?)\s*```/);
            if (genericMatch && genericMatch[1]) {
                return genericMatch[1].trim();
            }
            
            // If no fences, assume it might be plain JSON (or already erroneous)
            return str;
        }


        async function callDeepSeekAPI(systemPrompt, userPrompt, forMultipleFields = false) { 
            aiThinkingModal.classList.remove('hidden');
            const payload = {
                model: "deepseek-chat", 
                messages: [ { role: "system", content: systemPrompt }, { role: "user", content: userPrompt } ],
                stream: false,
            };
            try {
                const response = await fetch(DEEPSEEK_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${DEEPSEEK_API_KEY}`},
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`DS API Error ${response.status}: ${errorBody}`);
                }
                const result = await response.json();
                aiThinkingModal.classList.add('hidden');
                if (result.choices && result.choices.length > 0 && result.choices[0].message && result.choices[0].message.content) {
                    return result.choices[0].message.content;
                } else { throw new Error("Unexpected DS API response structure."); }
            } catch (error) {
                console.error("Error calling DeepSeek API:", error);
                aiThinkingModal.classList.add('hidden');
                return forMultipleFields ? { error: error.message } : `AI (DS) Error: ${error.message.substring(0,30)}`;
            }
        }

        async function generateRandomSuspectName() { /* Unchanged */
            const lastNames = ["李", "王", "張", "劉", "陳", "楊", "黃", "趙", "吳", "周"];
            const firstNamesMale = ["偉", "強", "磊", "軍", "勇", "傑", "濤", "明", "超", "鵬"];
            const firstNamesFemale = ["芳", "娜", "敏", "靜", "麗", "豔", "丹", "萍", "婷", "雪"];
            const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
            const gender = (Math.random() > 0.5) ? "男性" : "女性";
            const firstName = gender === "男性" ? firstNamesMale[Math.floor(Math.random() * firstNamesMale.length)] : firstNamesFemale[Math.floor(Math.random() * firstNamesFemale.length)];
            return { name: lastName + firstName, gender: gender };
        }
        
        async function generateInitialSuspectDetailsAndState() { /* Unchanged, uses cleanAIJsonResponse implicitly via generateSuspectObservableState */
            const { name, gender } = await generateRandomSuspectName();
            gameState.suspect.name = name;
            gameState.suspect.gender = gender;
            const dobTimestamp = Date.now() - Math.floor(Math.random() * 25 + 20) * 365 * 24 * 60 * 60 * 1000; 
            const birthDate = new Date(dobTimestamp);
            gameState.suspect.dob = `${birthDate.getFullYear()}年${birthDate.getMonth() + 1}月${birthDate.getDate()}日`;
            gameState.suspect.age = new Date().getFullYear() - birthDate.getFullYear();
            gameState.suspect.zodiac = getZodiacSign(birthDate.getDate(), birthDate.getMonth() + 1);
            gameState.suspect.bloodType = ["A", "B", "AB", "O"][Math.floor(Math.random() * 4)] + "型";
            gameState.suspect.heartRate = 70 + Math.floor(Math.random() * 10) - 5;
            gameState.suspect.bloodPressure = `${115 + Math.floor(Math.random() * 10) - 5}/${75 + Math.floor(Math.random() * 10) - 5}`;

            const systemPersonalityPrompt = "你是一位遊戲NPC設計師。請只提供個性描述文字，這段描述將作為偵訊技巧的關鍵參考，暗示嫌犯可能的弱點或應對方式。不要包含任何額外的說明或標籤。";
            const userPersonalityPrompt = `為以下背景的審問遊戲嫌犯 ${gameState.suspect.name} 生成一段簡短的個性概述（約20-40字），這段概述應暗示偵訊時可利用的突破口或其可能的行為模式：性別：${gameState.suspect.gender}，星座：${gameState.suspect.zodiac}，血型：${gameState.suspect.bloodType}，年齡：${gameState.suspect.age}歲。例如："此人外表強硬，但提及家人時可能情緒波動" 或 "極度自負，可能被奉承或質疑其能力所激怒"。`;
            const personalityResponse = await callDeepSeekAPI(systemPersonalityPrompt, userPersonalityPrompt);
            let cleanPersonality = personalityResponse;
             // Basic cleanup for personality, though less likely to have markdown
            if (typeof cleanPersonality === 'string') {
                cleanPersonality = cleanPersonality.replace(/```json|```/g, "").trim();
            }
            gameState.suspect.personality = (cleanPersonality && !cleanPersonality.startsWith("AI (DS) Error")) ? cleanPersonality : "性格複雜，需謹慎應對。";

            const initialObservables = await generateSuspectObservableState("遊戲剛開始，偵訊室氣氛嚴肅。");
            gameState.suspect.facialExpression = initialObservables.facialExpression || "面無表情";
            gameState.suspect.bodyLanguage = initialObservables.bodyLanguage || "雙手放在桌上";
            gameState.suspect.microAction = initialObservables.microAction || "偶爾眨眼";
            gameState.suspect.voiceTone = initialObservables.voiceTone || "語氣平靜";
        }

        async function generateNewCaseDetails() { /* Uses cleanAIJsonResponse */
            const systemPrompt = "你是懸疑案件劇情產生器。請為一個審問遊戲生成一個全新的謀殺案概要，包含驗屍報告、對嫌犯不利的證據、以及嫌犯的調查疑點。內容需符合邏輯。在證據和疑點中，若提及具體的物品、地點、時間或事件，請用 ## 將其包裹起來，例如 ##紅色圍巾## 或 ##案發當晚10點##。確保輸出為JSON格式，包含三個鍵：'autopsyReport' (字串), 'evidence' (字串陣列), 'doubts' (字串陣列)。不要包含任何markdown標記如```json或```。";
            const userPrompt = `生成一個新的謀殺案情節。嫌犯是 ${gameState.suspect.name} (${gameState.suspect.gender}, ${gameState.suspect.age}歲)。請確保案件有基本邏輯性，證據和疑點要有關聯性。例如，驗屍報告可包含死因、死亡時間；證據可以是現場發現的物品、目擊者證詞等；疑點可以是嫌犯的不在場證明瑕疵、與被害人關係等。`;
            
            let caseData = null;
            const rawResponse = await callDeepSeekAPI(systemPrompt, userPrompt, true);
            const jsonString = cleanAIJsonResponse(rawResponse);

            try {
                if (jsonString && !jsonString.startsWith("AI (DS) Error") && typeof jsonString !== 'object') { // Ensure it's a string before parsing
                    caseData = JSON.parse(jsonString);
                } else if (jsonString && typeof jsonString === 'object' && jsonString.error) { // API call itself returned an error object
                     console.error("API error generating case:", jsonString.error);
                }
            } catch (e) {
                console.error("Failed to parse case details JSON:", e, "Cleaned string:", jsonString, "Raw response:", rawResponse);
            }

            if (caseData && caseData.autopsyReport && Array.isArray(caseData.evidence) && Array.isArray(caseData.doubts)) {
                gameState.caseDetails.autopsyReport = caseData.autopsyReport;
                gameState.caseDetails.evidence = caseData.evidence.map((item, index) => 
                    typeof item === 'string' ? { text: item, id: `ev_new_${index}` } : item
                );
                gameState.caseDetails.doubts = caseData.doubts.map((item, index) => 
                    typeof item === 'string' ? { text: item, id: `db_new_${index}` } : item
                );
            } else {
                gameState.caseDetails.autopsyReport = `被害者 ${["張三","李四","王五"][Math.floor(Math.random()*3)]}，死於家中，初步判斷為他殺，死亡時間約為昨晚。現場發現 ##一把水果刀##。`;
                gameState.caseDetails.evidence = [ { text: `在被害者附近找到一把 ##沾血的刀子##。`, id: "ev_fb1"}, { text: `鄰居表示在 ##昨晚九點## 左右聽到激烈爭吵聲。`, id: "ev_fb2"}];
                gameState.caseDetails.doubts = [ { text: `嫌犯 ${gameState.suspect.name} 聲稱當時獨自在家。`, id: "db_fb1"}, { text: `嫌犯與被害者在 ##三天前## 曾因金錢問題發生過爭執。`, id: "db_fb2"}];
                console.warn("Using fallback case details due to generation/parsing error.");
            }
        }

        async function generateOpeningDialogue() { /* Unchanged */
            const officerOpeningSystemPrompt = "你是偵訊遊戲中的開場警官。你的任務是簡述案情並告知嫌犯權利。";
            const officerOpeningUserPrompt = `向嫌犯 ${gameState.suspect.name} 簡述偵查案件（基於以下案情概要：${gameState.caseDetails.autopsyReport.substring(0,50)}...）並告知其在台灣法律下的基本權利（你有權保持緘默；有權選任辯護人；你所說的一切都可能作為證據）。請直接給出完整的開場陳述，語氣嚴肅而專業。`;
            const officerOpeningText = await callDeepSeekAPI(officerOpeningSystemPrompt, officerOpeningUserPrompt);
            if (officerOpeningText && !officerOpeningText.startsWith("AI (DS) Error")) {
                gameState.dialogueHistory.push({ speaker: "警官", text: officerOpeningText, tone: "平緩" });
            } else {
                gameState.dialogueHistory.push({ speaker: "警官", text: `${gameState.suspect.name}，我們就一宗謀殺案向你進行詢問。你有權保持緘默，所說的話將可能成為證據。你也有權聘請律師。`, tone: "平緩" });
            }
            const suspectRebuttalSystemPrompt = `你是謀殺案嫌犯 ${gameState.suspect.name} (個性: ${gameState.suspect.personality})。你剛聽完警官的開場陳述及權利告知。`;
            const suspectRebuttalUserPrompt = `針對警官的開場陳述，生成一段簡短的狡辯回應，並提及台灣法律的無罪推定原則。`;
            const suspectRebuttalText = await callDeepSeekAPI(suspectRebuttalSystemPrompt, suspectRebuttalUserPrompt);
            if (suspectRebuttalText && !suspectRebuttalText.startsWith("AI (DS) Error")) {
                gameState.dialogueHistory.push({ speaker: "AI", text: suspectRebuttalText });
            } else {
                gameState.dialogueHistory.push({ speaker: "AI", text: "警官，我不明白。我是清白的，法律不是說無罪推定嗎？" });
            }
        }
        
        async function generateInterrogationTip() { /* Unchanged */
            const systemPrompt = "你是資深偵探，提供偵訊技巧提示。";
            const userPrompt = `根據目前嫌犯 ${gameState.suspect.name} 的個性（${gameState.suspect.personality}）和頑抗度（${getConfessionMeterText(gameState.confessionMeter)}），提供一句簡短的偵訊技巧提示（約15-25字）。例如："※面對強硬的嫌犯，適時沉默可能比追問更有效。" 或 "※當嫌犯情緒激動時，追問細節可能使其露出破綻。"。請以 "※ " 開頭。`;
            const tip = await callDeepSeekAPI(systemPrompt, userPrompt);
            if (tip && !tip.startsWith("AI (DS) Error")) {
                interrogationTipAreaEl.textContent = tip;
            } else {
                interrogationTipAreaEl.textContent = "※ 保持冷靜，觀察嫌犯的每一個反應。"; 
            }
        }

        async function generateGameAnalysis() { /* Unchanged */
            const systemPrompt = "你是案件分析員，負責在審問遊戲結束後提供心理攻防分析。";
            const dialogueSummary = gameState.dialogueHistory.slice(-10).map(msg => `${msg.speaker === "Player" ? "偵訊員" : gameState.suspect.name}(${msg.speaker === "警官" ? "警官" : msg.speaker}): ${msg.text}`).join("\n");
            const userPrompt = `審問遊戲已結束。嫌犯 ${gameState.suspect.name} ${gameState.confessionMeter <= 0 ? "已認罪" : "未認罪"}。總共耗費 ${gameState.round} 回合。頑抗度最終為 ${getConfessionMeterText(gameState.confessionMeter)} (${gameState.confessionMeter}%)。\n嫌犯個性為：${gameState.suspect.personality}。\n部分對話記錄摘要：\n${dialogueSummary}\n請根據以上資訊，提供一段約50-100字的心理攻防分析，評價雙方的表現，並指出可能的轉折點或策略。`;
            const analysis = await callDeepSeekAPI(systemPrompt, userPrompt);
            if (analysis && !analysis.startsWith("AI (DS) Error")) {
                gameState.gameAnalysis = analysis;
            } else {
                gameState.gameAnalysis = "本次審問過程複雜，未能成功獲取AI生成的詳細分析。請檢查API連線或提示詞。";
            }
        }

        async function loadOrCreateNewGame() { /* Unchanged */
            gameId = `game_${Date.now()}`; 
            gameState = getDefaultGameState(); 
            if (!userId) { 
                await generateInitialSuspectDetailsAndState(); 
                await generateNewCaseDetails();
                await generateOpeningDialogue();
                await generateInterrogationTip(); 
                updateUI(gameState); 
                adjustAvatarSize();
                return;
            }
            const gameDocRef = await getGameDocRef();
            if (gameStateUnsubscribe) gameStateUnsubscribe(); 
            console.log("Starting new game for user:", userId, "Game ID:", gameId);
            await generateInitialSuspectDetailsAndState(); 
            await generateNewCaseDetails(); 
            await generateOpeningDialogue(); 
            await generateInterrogationTip(); 
            try {
                await setDoc(gameDocRef, { ...gameState, createdAt: serverTimestamp(), lastUpdatedAt: serverTimestamp() });
                console.log("New game state saved to Firestore.");
            } catch (error) {
                console.error("Error saving new game state to Firestore:", error);
            }
            updateUI(gameState);
            adjustAvatarSize();
            gameStateUnsubscribe = onSnapshot(gameDocRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    console.log("Game state updated from Firestore:", docSnapshot.data());
                    const remoteGameState = docSnapshot.data();
                    gameState = { ...gameState, ...remoteGameState }; 
                     if (!gameState.suspect || !gameState.suspect.dob || !gameState.suspect.facialExpression) {
                        generateInitialSuspectDetailsAndState().then(() => updateUI(gameState));
                    } else {
                        updateUI(gameState);
                    }
                     adjustAvatarSize(); 
                }
            }, (error) => console.error("Error in onSnapshot listener:", error));
        }

        async function saveGameState() { /* Unchanged */
            if (!userId) return; 
            const gameDocRef = await getGameDocRef();
            if (!gameDocRef) return;
            try {
                await setDoc(gameDocRef, { ...gameState, lastUpdatedAt: serverTimestamp() }, { merge: true });
            } catch (error) { console.error("Error saving game state:", error); }
        }
        
        function getZodiacSign(day, month) { /* Unchanged */
            const zodiacSigns = [
                { sign: "摩羯座", start: [12, 22], end: [1, 19] }, { sign: "水瓶座", start: [1, 20], end: [2, 18] },
                { sign: "雙魚座", start: [2, 19], end: [3, 20] }, { sign: "白羊座", start: [3, 21], end: [4, 19] },
                { sign: "金牛座", start: [4, 20], end: [5, 20] }, { sign: "雙子座", start: [5, 21], end: [6, 21] },
                { sign: "巨蟹座", start: [6, 22], end: [7, 22] }, { sign: "獅子座", start: [7, 23], end: [8, 22] },
                { sign: "處女座", start: [8, 23], end: [9, 22] }, { sign: "天秤座", start: [9, 23], end: [10, 23] },
                { sign: "天蠍座", start: [10, 24], end: [11, 22] }, { sign: "射手座", start: [11, 23], end: [12, 21] }
            ];
            for (const z of zodiacSigns) {
                if ((month === z.start[0] && day >= z.start[1]) || (month === z.end[0] && day <= z.end[1])) { return z.sign; }
            }
            return "未知";
        }

        async function getAIResponse(playerMessage) { /* Unchanged */
            const evidenceText = gameState.caseDetails.evidence.map(e => e.text.replace(/<[^>]*>/g, "")).join("；");
            const doubtsText = gameState.caseDetails.doubts.map(d => d.text.replace(/<[^>]*>/g, "")).join("；");
            const systemPrompt = `你是謀殺案嫌犯 ${gameState.suspect.name} (個性: ${gameState.suspect.personality})。\n你目前的頑抗度被描述為「${getConfessionMeterText(gameState.confessionMeter)}」。\n生理狀態：心率 ${gameState.suspect.heartRate} bpm，血壓 ${gameState.suspect.bloodPressure}。\n外在表現：表情 ${gameState.suspect.facialExpression}，肢體 ${gameState.suspect.bodyLanguage}，微動作 ${gameState.suspect.microAction}，語氣 ${gameState.suspect.voiceTone}。\n你的目標是盡可能不認罪，但回答要符合你的個性和當前情境。\n如果你的情緒變得激動、慌亂或試圖胡言亂語，你可以用多個簡短的對話框來回應（用 "||" 分隔每個對話框的內容）。\n回答時，如果提到案件相關的關鍵物品或地點（例如：槌子、公寓、公園、刀械、被害者姓名、特定時間點），請在該詞彙前後加上 @@，例如 @@槌子@@。\n你的回答應該簡潔有力。`;
            const userPrompt = `目前對你不利的證據有：${evidenceText}。調查人員對你的疑點是：${doubtsText}。審問者（玩家）用「${gameState.selectedTone}」的語氣問你：「${playerMessage}」`;
            const response = await callDeepSeekAPI(systemPrompt, userPrompt);
            if (response && !response.startsWith("AI (DS) Error")) { return response.split("||").map(r => r.trim()); }
            return ["我不知道你在說什麼。"]; 
        }

        async function getKeywordInfo(keyword) { /* Unchanged */
            keywordLoadingSpinner.classList.remove('hidden');
            keywordModalText.textContent = ""; 
            const systemPrompt = "你是一位偵探助手，提供案件線索。";
            const userPrompt = `在一個謀殺案的審問情境中，提到了關鍵字「${keyword}」。請針對這個關鍵字，提供一段簡短（約30-50字）的補充資訊或線索，這段資訊應該對玩家（審問者）有所幫助。例如，如果關鍵字是「槌子」，你可以說：「警方在案發現場找到一把帶有血跡的槌子，上面同時有被害者的DNA和一枚模糊的指紋，正在進行比對。」如果關鍵字是「公園」，你可以說：「根據通訊記錄，被害者手機最後的訊號位置是在城市中央公園附近。」請直接給出補充資訊，不要有額外的開頭或結尾。`;
            const info = await callDeepSeekAPI(systemPrompt, userPrompt);
            keywordLoadingSpinner.classList.add('hidden');
            if (info && !info.startsWith("AI (DS) Error")) { keywordModalText.textContent = info; } 
            else { keywordModalText.textContent = `關於「${keyword}」的更多資訊目前無法取得。`; }
        }
        
        async function generateSuspectObservableState(lastAIMessage = "") { /* Uses cleanAIJsonResponse */
            const systemPrompt = "你是犯罪心理側寫師。根據提供的嫌犯資料和最近的對話，生成一個JSON格式的對象，描述嫌犯當前的外在表現。請確保只返回合法的JSON對象，不要包含任何markdown標記如```json或```。";
            const userPrompt = `嫌犯 ${gameState.suspect.name} (個性: ${gameState.suspect.personality})。\n目前心率: ${gameState.suspect.heartRate} bpm，血壓: ${gameState.suspect.bloodPressure} mmHg。\n頑抗度描述為「${getConfessionMeterText(gameState.confessionMeter)}」(內部數值: ${gameState.confessionMeter}%)。\n他剛剛說了 (或被問了): "${lastAIMessage || '偵訊剛開始'}"。\n請生成一個合法的JSON對象，包含以下四個鍵值對，每個值都是一段簡短的描述 (每項約5-10字):\n"facialExpression": (例如："嘴角微微抽動", "眼神有些飄忽不定", "面無表情但眉頭微蹙")\n"bodyLanguage": (例如："雙手緊握放在桌上", "坐立不安，身體稍微後仰", "身體微微前傾，似乎想解釋")\n"microAction": (例如："手指不自覺地輕敲桌面", "下意識撥弄衣角", "短暫地舔了舔嘴唇")\n"voiceTone": (例如："語氣平淡，聽不出情緒", "聲音略顯沙啞", "試圖保持強硬但略帶顫抖")\n確保輸出為一個單一的、合法的JSON對象，不要有任何額外的文字或標記。`;
            
            const rawResponse = await callDeepSeekAPI(systemPrompt, userPrompt, true); 
            const jsonString = cleanAIJsonResponse(rawResponse);
            
            try {
                if (jsonString && !jsonString.startsWith("AI (DS) Error") && typeof jsonString !== 'object') {
                    const parsed = JSON.parse(jsonString);
                    if (typeof parsed === 'object' && parsed !== null && 
                        'facialExpression' in parsed && 'bodyLanguage' in parsed &&
                        'microAction' in parsed && 'voiceTone' in parsed) {
                        return parsed;
                    } else {
                         console.warn("Parsed JSON for observable state is not in expected format:", parsed);
                    }
                } else if (jsonString && typeof jsonString === 'object' && jsonString.error) {
                    console.error("DS API returned an error for observable state:", jsonString.error);
                }
            } catch (e) { 
                console.error("Failed to parse observable state JSON:", e, "Cleaned string:", jsonString, "Raw response:", rawResponse); 
            }
            console.warn("Using fallback observable state.");
            return { facialExpression: "鎮定自若", bodyLanguage: "姿態放鬆", microAction: "無明顯", voiceTone: "語氣平穩"};
        }

        async function updateSuspectStatus(lastAIMessage = "") { /* Unchanged */
            let hrChange = Math.floor(Math.random() * 10) - 5; 
            let bpSysChange = Math.floor(Math.random() * 10) - 5;
            let bpDiaChange = Math.floor(Math.random() * 6) - 3;
            if (gameState.confessionMeter < 50) { 
                hrChange += Math.floor(Math.random() * (gameState.confessionMeter < 25 ? 10 : 5)) + (gameState.confessionMeter < 25 ? 3 : 2); 
                bpSysChange += Math.floor(Math.random() * (gameState.confessionMeter < 25 ? 10 : 5)) + (gameState.confessionMeter < 25 ? 3 : 2);
            } else { 
                 hrChange -= Math.floor(Math.random() * 3); 
                 bpSysChange -= Math.floor(Math.random() * 3);
            }
            gameState.suspect.heartRate = Math.max(60, Math.min(140, gameState.suspect.heartRate + hrChange)); 
            let [sys, dia] = gameState.suspect.bloodPressure.split('/').map(Number);
            sys = Math.max(90, Math.min(190, sys + bpSysChange));
            dia = Math.max(60, Math.min(120, dia + bpDiaChange));
            gameState.suspect.bloodPressure = `${sys}/${dia}`;
            const newObservables = await generateSuspectObservableState(lastAIMessage);
            gameState.suspect.facialExpression = newObservables.facialExpression || gameState.suspect.facialExpression; 
            gameState.suspect.bodyLanguage = newObservables.bodyLanguage || gameState.suspect.bodyLanguage;
            gameState.suspect.microAction = newObservables.microAction || gameState.suspect.microAction;
            gameState.suspect.voiceTone = newObservables.voiceTone || gameState.suspect.voiceTone;
        }

        function updateUI(state) { /* Unchanged */
            if (!state) return;
            roundCountEl.textContent = state.round;
            confessionMeterTextEl.textContent = getConfessionMeterText(state.confessionMeter); 
            if (state.suspect) {
                suspectStatusNameEl.textContent = state.suspect.name; 
                heartRateEl.textContent = state.suspect.heartRate;
                bloodPressureEl.textContent = state.suspect.bloodPressure;
                facialExpressionEl.textContent = state.suspect.facialExpression;
                bodyLanguageEl.textContent = state.suspect.bodyLanguage;
                microActionEl.textContent = state.suspect.microAction;
                voiceToneEl.textContent = state.suspect.voiceTone;
                suspectNameModalEl.textContent = state.suspect.name;
                dobModalEl.textContent = state.suspect.dob || "N/A";
                zodiacModalEl.textContent = state.suspect.zodiac || "N/A";
                bloodTypeModalEl.textContent = state.suspect.bloodType || "N/A";
                ageModalEl.textContent = state.suspect.age || "N/A";
                genderModalEl.textContent = state.suspect.gender || "N/A";
                personalityModalEl.textContent = state.suspect.personality || "讀取中...";
            }
            if (state.caseDetails) { 
                autopsyReportModalContentEl.innerHTML = state.caseDetails.autopsyReport.replace(/##(.*?)##/g, '<span class="case-keyword" data-keyword="$1">$1</span>').replace(/\n/g, "<br>");
                evidenceListModalContentEl.innerHTML = state.caseDetails.evidence.map(e => `<li data-id="${e.id}">${e.text.replace(/##(.*?)##/g, '<span class="case-keyword" data-keyword="$1">$1</span>')}</li>`).join('');
                doubtsListModalContentEl.innerHTML = state.caseDetails.doubts.map(d => `<li data-id="${d.id}">${d.text.replace(/##(.*?)##/g, '<span class="case-keyword" data-keyword="$1">$1</span>')}</li>`).join('');
            }
            dialogueAreaEl.innerHTML = ''; 
            if (state.dialogueHistory) {
                state.dialogueHistory.forEach(msg => addMessageToDialogue(msg.speaker, msg.text, msg.tone)); 
            }
            document.querySelectorAll('.case-keyword').forEach(el => {
                el.onclick = () => {
                    const keyword = el.dataset.keyword;
                    keywordModalTitle.textContent = `🔑 關於「${keyword}」`;
                    getKeywordInfo(keyword); 
                    keywordModal.classList.remove('hidden');
                };
            });
            if (state.gameOver) {
                gameOverTitle.textContent = state.confessionMeter <= 0 ? "⚖️ 審問成功！" : "⚖️ 審問失敗！";
                totalRoundsEl.textContent = state.round;
                gameAnalysisTextEl.textContent = state.gameAnalysis || "分析生成失敗。";
                gameOverModal.classList.remove('hidden');
            } else {
                gameOverModal.classList.add('hidden');
            }
            adjustAvatarSize();
        }

        function addMessageToDialogue(speaker, text, tone = null) { /* Unchanged */
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('dialogue-bubble');
            let messageContent = text;
            if (speaker === 'Player') {
                messageDiv.classList.add('player-bubble');
                messageContent = `(語氣：${tone || '未知'}) ${text}`; 
                switch (tone) {
                    case '平緩': messageDiv.classList.add('player-bubble-calm'); break;
                    case '憤怒': messageDiv.classList.add('player-bubble-angry'); break;
                    case '挑釁': messageDiv.classList.add('player-bubble-provocative'); break;
                }
            } else if (speaker === '警官') { 
                messageDiv.classList.add('officer-bubble'); 
                messageContent = `<strong>警官：</strong> ${text}`;
            } else { 
                messageDiv.classList.add('ai-bubble');
            }
            const processedText = messageContent.replace(/@@(.*?)@@/g, '<span class="keyword" data-keyword="$1">$1</span>');
            messageDiv.innerHTML = processedText;
            dialogueAreaEl.appendChild(messageDiv);
            dialogueAreaEl.scrollTop = dialogueAreaEl.scrollHeight; 
            messageDiv.querySelectorAll('.keyword').forEach(el => {
                el.onclick = () => {
                    const keyword = el.dataset.keyword;
                    keywordModalTitle.textContent = `🔑 關於「${keyword}」`;
                    getKeywordInfo(keyword); 
                    keywordModal.classList.remove('hidden');
                };
            });
        }

        async function handlePlayerTurn() { /* Unchanged */
            const playerMessage = playerInputEl.value.trim();
            if (!playerMessage) return;
            if (playerMessage === "88888888") {
                gameState.confessionMeter = 0; gameState.gameOver = true;
                await generateGameAnalysis(); 
                updateUI(gameState); await saveGameState(); playerInputEl.value = ''; return;
            }
            sendButton.disabled = true;
            sendButton.innerHTML = '<div class="loading-spinner !w-5 !h-5 border-t-white"></div>';
            const currentTone = gameState.selectedTone; 
            gameState.round++;
            addMessageToDialogue('Player', playerMessage, currentTone);
            gameState.dialogueHistory.push({ speaker: 'Player', text: playerMessage, tone: currentTone });
            playerInputEl.value = '';
            const aiResponses = await getAIResponse(playerMessage);
            aiResponses.forEach(response => {
                addMessageToDialogue('AI', response);
                gameState.dialogueHistory.push({ speaker: 'AI', text: response });
            });
            let decrease = 5 + Math.floor(Math.random() * 10); 
            if (currentTone === "挑釁" && Math.random() < 0.4) decrease += 5; 
            if (currentTone === "憤怒" && Math.random() < 0.2) decrease -= 3; 
            if (playerMessage.length > 30 && Math.random() < 0.3) decrease +=3; 
            gameState.confessionMeter = Math.max(0, gameState.confessionMeter - decrease);
            await updateSuspectStatus(aiResponses.join(" ")); 
            await generateInterrogationTip(); 
            if (gameState.confessionMeter <= 0 && !gameState.gameOver) { 
                gameState.gameOver = true;
                const confessionMsg = `${gameState.suspect.name}: ...好吧，我承認...是我做的。`;
                addMessageToDialogue('AI', confessionMsg);
                gameState.dialogueHistory.push({ speaker: 'AI', text: confessionMsg });
                await generateGameAnalysis(); 
            }
            updateUI(gameState); 
            await saveGameState();
            sendButton.disabled = false;
            sendButton.innerHTML = '發送';
        }

        function restartGame() { /* Unchanged */
            loadOrCreateNewGame(); 
            gameOverModal.classList.add('hidden'); 
        }

        // Event Listeners
        sendButton.addEventListener('click', handlePlayerTurn);
        playerInputEl.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handlePlayerTurn(); }
        });
        toneButtons.forEach(button => {
            button.addEventListener('click', () => {
                toneButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                gameState.selectedTone = button.dataset.tone;
            });
        });
        showPersonalDetailsButton.addEventListener('click', () => personalDetailsModal.classList.remove('hidden'));
        showStorySummaryButton.addEventListener('click', () => storySummaryModal.classList.remove('hidden'));
        restartGameButton.addEventListener('click', restartGame);

        window.addEventListener('load', () => { initializeGame(); });
        window.addEventListener('resize', adjustAvatarSize); 

    </script>
</body>
</html>
